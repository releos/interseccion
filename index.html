<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Intersecci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Librer√≠as para el calendario (Flatpickr) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .tab-button.active { background-color: #4f46e5; color: #ffffff; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .modal-content-scroll::-webkit-scrollbar { width: 8px; }
        .modal-content-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .modal-content-scroll::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        #toast-notification {
            position: fixed;
            bottom: -100px;
            right: 20px;
            background-color: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast-notification.show { bottom: 20px; }
        .filter-btn { background-color: #374151; }
        .filter-btn.active { background-color: #4f46e5; }
        /* Estilos para el calendario Flatpickr en modo oscuro */
        .flatpickr-calendar.dark { background: #1f2937; border-color: #374151; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .flatpickr-calendar.dark .flatpickr-month, .flatpickr-calendar.dark .flatpickr-weekday, .flatpickr-calendar.dark .flatpickr-day { color: #d1d5db; }
        .flatpickr-calendar.dark .flatpickr-day.today { border-color: #4f46e5; }
        .flatpickr-calendar.dark .flatpickr-day.selected, .flatpickr-calendar.dark .flatpickr-day.startRange, .flatpickr-calendar.dark .flatpickr-day.endRange { background: #4f46e5; border-color: #4f46e5; color: #fff; }
        .flatpickr-calendar.dark .flatpickr-day:hover { background: #374151; }
        .flatpickr-calendar.dark .flatpickr-day.inRange { background: rgba(79, 70, 229, 0.2); box-shadow: none; border-color: transparent; }
        .flatpickr-calendar.dark .numInput, .flatpickr-calendar.dark .arrowUp, .flatpickr-calendar.dark .arrowDown { color: #d1d5db; }
        
        /* Estilo Spoiler */
        .spoiler-content { filter: blur(8px); user-select: none; transition: filter 0.5s ease; }
        .spoiler-content.revealed { filter: blur(0); user-select: auto; }
        .spoiler-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 10; background: rgba(0,0,0,0.3); border-radius: 0.5rem; }
    </style>
</head>
<body class="text-gray-200">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">La Intersecci√≥n</h1>
            <p class="mt-2 text-lg text-gray-400">Un juego de misterios semanales.</p>
            <!-- User ID Display -->
            <div id="user-id-display" class="mt-4 md:absolute md:top-0 md:right-0 bg-gray-800 border border-gray-700 rounded-lg p-2 text-sm text-gray-300 cursor-pointer hover:bg-gray-700 transition" title="Haz clic para gestionar tu ID">
                ID: <span id="current-user-id-short" class="font-mono text-indigo-400 font-bold">...</span>
            </div>
        </header>

        <nav class="flex justify-center border-b border-gray-700 mb-8 overflow-x-auto">
            <button data-tab="en-curso" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition active whitespace-nowrap">Misterios en Curso</button>
            <button data-tab="archivo" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition whitespace-nowrap">Archivo de Soluciones</button>
            <button data-tab="podio" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition whitespace-nowrap">Podio</button>
            <button data-tab="sobre" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition whitespace-nowrap">Sobre el Proyecto</button>
        </nav>

        <main>
            <div id="en-curso" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-6 min-h-[100px]"></div>
            
            <div id="archivo" class="tab-content hidden min-h-[100px] relative">
                 <!-- Bot√≥n para mostrar/ocultar filtros -->
                <div class="flex justify-end mb-4">
                    <button id="toggle-filters-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                        <span id="toggle-filters-text">Filtros</span>
                    </button>
                </div>
                <!-- Contenedor de filtros (inicialmente oculto) -->
                <div id="filters-container" class="hidden mb-6 bg-gray-800/50 p-4 rounded-xl fade-in space-y-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="relative flex-grow">
                            <input type="text" id="search-text" placeholder="Buscar en soluciones, explicaciones, t√≠tulos..." class="w-full bg-gray-700 border-gray-600 rounded-lg p-3 pl-10 focus:ring-2 focus:ring-indigo-500 transition border">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="date-filter-container">
                            <input type="text" id="search-date" placeholder="Filtrar por fecha de inicio" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                        </div>
                    </div>
                    <div id="type-filter-container" class="flex flex-wrap items-center gap-2">
                        <span class="text-sm font-medium text-gray-400 mr-2">Tipo:</span>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors active" data-type="Todos">Todos</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Semanal">Semanal</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Diario">Diario</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Rel√°mpago">Rel√°mpago</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Especial">Especial</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Tutorial">Tutorial</button>
                    </div>
                    <div id="difficulty-filter-container" class="flex flex-wrap items-center gap-2">
                        <span class="text-sm font-medium text-gray-400 mr-2">Dificultad:</span>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors active" data-difficulty="Todos">Todos</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-difficulty="F√°cil">F√°cil üòá</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-difficulty="Medio">Medio üßê</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-difficulty="Dif√≠cil">Dif√≠cil üòà</button>
                    </div>
                    <!-- Nuevo filtro de Favoritos -->
                    <div class="flex items-center gap-2 mt-2">
                         <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="favorites-filter" class="form-checkbox h-5 w-5 text-indigo-600 rounded bg-gray-700 border-gray-600 focus:ring-indigo-500">
                            <span class="text-sm font-medium text-yellow-400">Mostrar solo Favoritos ‚≠ê</span>
                        </label>
                    </div>
                </div>
                <!-- Contenedor para los juegos resueltos -->
                <div id="archivo-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
            
            <!-- Nueva Pesta√±a Podio -->
            <div id="podio" class="tab-content hidden min-h-[100px]">
                <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-indigo-400 mb-4 flex items-center gap-2">
                        üèÜ Tabla de Clasificaci√≥n
                    </h2>
                    <p class="text-gray-400 mb-6">Los mejores detectives de La Intersecci√≥n. ¬øEst√°s en la lista?</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-gray-300">
                            <thead class="bg-gray-700/50 text-xs uppercase font-bold text-gray-400">
                                <tr>
                                    <th class="px-6 py-3">Posici√≥n</th>
                                    <th class="px-6 py-3">Nombre</th>
                                    <th class="px-6 py-3 text-right">Puntos</th>
                                    <th class="px-6 py-3 text-center">Insignias</th>
                                </tr>
                            </thead>
                            <tbody id="podium-table-body" class="divide-y divide-gray-700">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="podium-loading" class="text-center py-8 text-gray-500">Cargando clasificaci√≥n...</div>
                    <div id="podium-error" class="hidden text-center py-8 text-red-400">No se pudo cargar la clasificaci√≥n.</div>
                </div>
            </div>

            <div id="sobre" class="tab-content hidden relative pb-8">
                 <div class="space-y-8 fade-in">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-8">
                        <h2 class="text-3xl font-bold text-indigo-400 mb-4">¬øQu√© es "La Intersecci√≥n"?</h2>
                        <p class="text-gray-300 leading-relaxed">Este es un peque√±o proyecto de entretenimiento inspirado en el famoso concurso "Saber y Ganar". El objetivo es adivinar "la intersecci√≥n" ‚Äîque puede ser una persona, un lugar, una pel√≠cula, una canci√≥n o cualquier cosa imaginable‚Äî a partir de peque√±as pistas que se ir√°n revelando semanalmente. Es un reto a la paciencia, la deducci√≥n y la cultura general.</p>
                    </div>
                    <div class="grid md:grid-cols-5 gap-8">
                        <div class="md:col-span-3 bg-gray-800 rounded-xl shadow-lg p-8">
                            <h3 class="text-2xl font-bold text-indigo-400 mb-6">¬øC√≥mo se juega?</h3>
                            <ol class="space-y-5">
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">1</div><div class="pt-1">Visita la pesta√±a <strong>Misterios en Curso</strong> o el <strong>Archivo</strong> para elegir un juego.</div></li>
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">2</div><div class="pt-1">Si est√° resuelto, puedes elegir entre ver la soluci√≥n directamente o jugar pista a pista.</div></li>
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">3</div><div class="pt-1">Cuando creas tener la soluci√≥n (en un juego en curso), ¬°usa el formulario para enviarla! <strong>Tu ID se copiar√° autom√°ticamente.</strong></div></li>
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">4</div><div class="pt-1">Puedes guardar tus misterios favoritos y consultar el <strong>Podio</strong> para ver tu clasificaci√≥n.</div></li>
                            </ol>
                             <div class="mt-8 text-center">
                                <button id="instructions-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105">Instrucciones detalladas y Registro</button>
                            </div>
                        </div>
                        <div class="md:col-span-2 bg-gray-800 rounded-xl shadow-lg p-8 flex flex-col">
                             <h3 class="text-2xl font-bold text-indigo-400 mb-6">Contacto y Opiniones</h3>
                             <div class="space-y-4 flex-grow flex flex-col justify-center">
                                <a href="https://www.instagram.com/interseccion_juego?igsh=MWw5c3YxYXcwa3Vmbg==" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-4 bg-gray-700/50 hover:bg-gray-700 p-4 rounded-lg transition-all">
                                     <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-purple-600 via-pink-600 to-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.917 3.917 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zM8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm0 1.442a2.558 2.558 0 1 0 0 5.116 2.558 2.558 0 0 0 0-5.116z"/></svg></div>
                                     <div><div class="font-bold text-white">Instagram</div><div class="text-sm text-gray-400 group-hover:text-gray-200 transition">Sigue el juego</div></div>
                                 </a>
                                 <a href="https://forms.gle/CTqcoBsGsf2kX1WKA" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-4 bg-gray-700/50 hover:bg-gray-700 p-4 rounded-lg transition-all">
                                     <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center bg-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="text-white" viewBox="0 0 16 16"><path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 0 1.5H4.5A1 1 0 0 0 3.5 3h10a1 1 0 0 0 1-1 .75.75 0 0 1 1.5 0v1A1.5 1.5 0 0 1 14.5 4h-13A1.5 1.5 0 0 1 0 2.5v-1A1.5 1.5 0 0 1 1.5 0H2z"/><path d="M16 5.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 5.5v-1A1.5 1.5 0 0 1 1.5 3H2a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1h.5a1.5 1.5 0 0 1 1.5 1.5v1zM1.5 9h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1zm0 2.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1z"/></svg></div>
                                     <div><div class="font-bold text-white">Dame tu opini√≥n</div><div class="text-sm text-gray-400 group-hover:text-gray-200 transition">Formulario de feedback</div></div>
                                 </a>
                                 <button id="example-game-btn" class="group flex items-center gap-4 bg-gray-700/50 hover:bg-gray-700 p-4 rounded-lg transition-all w-full text-left">
                                     <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center bg-teal-500"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="text-white" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg></div>
                                     <div><div class="font-bold text-white">Misterio de Ejemplo</div><div class="text-sm text-gray-400 group-hover:text-gray-200 transition">Prueba el juego</div></div>
                                 </button>
                             </div>
                        </div>
                    </div>
                 </div>
                 <div class="absolute bottom-2 right-2 text-xs text-gray-600">v8.1 (Fixes)</div>
            </div>
        </main>
    </div>

    <!-- Modal Structure -->
    <div id="game-modal" class="modal fixed inset-0 bg-black bg-opacity-80 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                <div class="flex-grow min-w-0">
                    <h2 id="modal-title" class="text-2xl font-bold text-white truncate"></h2>
                    <div id="modal-badges" class="flex items-center gap-2 mt-1"></div>
                </div>
                <button id="modal-close-btn" class="flex-shrink-0 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </header>
            <div id="modal-content" class="p-6 overflow-y-auto modal-content-scroll"></div>
            <footer id="modal-footer" class="flex-shrink-0 p-4 border-t border-gray-700"></footer>
        </div>
    </div>
    
    <!-- User ID Management Modal -->
    <div id="user-id-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 max-w-lg w-full relative">
            <button id="close-user-id-x" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="text-2xl font-extrabold text-indigo-400 mb-4">Gesti√≥n de Identidad</h3>
            <p class="text-gray-300 mb-4">Este es tu identificador √∫nico para el juego y el podio. <strong>¬°No lo pierdas!</strong></p>
            
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mb-6 flex items-center justify-between">
                <code id="full-user-id" class="text-green-400 font-mono text-lg break-all">...</code>
                <button id="copy-id-btn" class="ml-4 text-gray-400 hover:text-white" title="Copiar ID">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
            </div>

            <div class="bg-red-900/30 border border-red-500/50 p-4 rounded-lg mb-6">
                <p class="text-sm text-red-200"><strong>¬°Advertencia!</strong> Si pierdes o borras este ID (limpiando cookies, por ejemplo), perder√°s el acceso a tu progreso y puntuaciones en el podio. Gu√°rdalo en un lugar seguro.</p>
            </div>

            <div class="space-y-3">
                <button id="download-id-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Descargar mi ID (Recomendado)
                </button>
                <div class="relative">
                    <input type="file" id="upload-id-input" accept=".html" class="hidden">
                    <button id="upload-id-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        Subir ID Guardado
                    </button>
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="close-user-id-modal" class="text-gray-400 hover:text-white underline text-sm">Cerrar y continuar jugando</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification"></div>
    
    <!-- Hidden Alert Modal for External Redirect -->
    <div id="redirect-alert-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-[60]">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 max-w-md w-full text-center border border-indigo-500">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Preparando env√≠o...</h3>
            <p class="text-gray-300 mb-4 text-left text-sm">
                Se va a abrir el formulario. Hemos copiado tu ID <strong class="text-indigo-400" id="redirect-modal-id"></strong> y lo intentaremos rellenar autom√°ticamente.
            </p>
            <p class="bg-yellow-900/50 border border-yellow-600/50 p-3 rounded text-yellow-200 text-sm mb-6 text-left">
                <strong>Importante:</strong> Introduce el nombre con el que deseas aparecer en el <strong>Podio</strong> en el campo correspondiente del formulario.
            </p>
            <div class="flex gap-3 justify-center">
                <button id="cancel-redirect-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition">Cancelar</button>
                <button id="confirm-redirect-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">Entendido, ir al formulario</button>
            </div>
        </div>
    </div>

    <script>
        const dom = {
            tabs: document.querySelectorAll('.tab-button'), tabContents: document.querySelectorAll('.tab-content'), enCursoContainer: document.getElementById('en-curso'), archivoContainer: document.getElementById('archivo'), archivoGrid: document.getElementById('archivo-grid'),
            modal: document.getElementById('game-modal'), modalTitle: document.getElementById('modal-title'), modalContent: document.getElementById('modal-content'), modalFooter: document.getElementById('modal-footer'), modalCloseBtn: document.getElementById('modal-close-btn'), modalBadges: document.getElementById('modal-badges'),
            exampleGameBtn: document.getElementById('example-game-btn'),
            searchText: document.getElementById('search-text'),
            searchDate: document.getElementById('search-date'),
            typeFilterContainer: document.getElementById('type-filter-container'),
            difficultyFilterContainer: document.getElementById('difficulty-filter-container'),
            toggleFiltersBtn: document.getElementById('toggle-filters-btn'),
            filtersContainer: document.getElementById('filters-container'),
            instructionsBtn: document.getElementById('instructions-btn'),
            // User ID DOM
            userIdDisplay: document.getElementById('user-id-display'),
            currentUserIdShort: document.getElementById('current-user-id-short'),
            userIdModal: document.getElementById('user-id-modal'),
            fullUserId: document.getElementById('full-user-id'),
            copyIdBtn: document.getElementById('copy-id-btn'),
            downloadIdBtn: document.getElementById('download-id-btn'),
            uploadIdBtn: document.getElementById('upload-id-btn'),
            uploadIdInput: document.getElementById('upload-id-input'),
            closeUserIdModal: document.getElementById('close-user-id-modal'),
            closeUserIdX: document.getElementById('close-user-id-x'),
            // Redirect Modal DOM
            redirectAlertModal: document.getElementById('redirect-alert-modal'),
            redirectModalId: document.getElementById('redirect-modal-id'),
            cancelRedirectBtn: document.getElementById('cancel-redirect-btn'),
            confirmRedirectBtn: document.getElementById('confirm-redirect-btn'),
            // Podium
            podiumTableBody: document.getElementById('podium-table-body'),
            podiumLoading: document.getElementById('podium-loading'),
            podiumError: document.getElementById('podium-error'),
            // Favorites
            favoritesFilter: document.getElementById('favorites-filter'),
        };

        const GAMES_INDEX_PATH = 'games/index.json';
        const EXAMPLE_GAME_PATH = 'games/ejemplo_resuelto.json'; 
        const LEADERBOARD_PATH = 'games/leaderboard.json';
        let allGames = [];
        let datePicker;
        let currentGameData = null;
        let revealedClueCount = 0;
        let userId = '';
        let pendingRedirectUrl = '';
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        // --- GESTI√ìN DE USUARIO (UUID) ---
        function initUser() {
            userId = localStorage.getItem('userId');
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('userId', userId);
                dom.userIdModal.classList.add('active'); // Mostrar modal si es nuevo
            }
            updateUserDisplay();
        }

        function updateUserDisplay() {
            dom.currentUserIdShort.textContent = userId.substring(0, 8) + '...';
            dom.fullUserId.textContent = userId;
        }

        function downloadUserId() {
            const htmlContent = `
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Mi ID - La Intersecci√≥n</title><style>body{font-family:sans-serif;background:#111;color:#eee;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;text-align:center}.box{background:#222;padding:2rem;border-radius:10px;border:1px solid #444}code{background:#000;padding:5px 10px;color:#4ade80;display:block;margin:10px 0;font-size:1.2rem}h1{color:#6366f1}</style></head>
<body><div class="box"><h1>Resguardo de Identidad</h1><p>Este archivo contiene tu ID para el juego La Intersecci√≥n.</p><code>${userId}</code><p>Sube este archivo en la web si pierdes tu sesi√≥n.</p><div id="id-data" style="display:none">${userId}</div></div></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mi_id.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleUploadId(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const match = content.match(/<div id="id-data" style="display:none">(.*?)<\/div>/);
                if (match && match[1]) {
                    const newId = match[1].trim();
                    if (/^[0-9a-fA-F-]{36}$/.test(newId)) { // Basic UUID check
                        userId = newId;
                        localStorage.setItem('userId', userId);
                        updateUserDisplay();
                        showToast('ID cargado correctamente');
                        dom.userIdModal.classList.remove('active');
                    } else { showToast('El archivo no contiene un ID v√°lido', true); }
                } else { showToast('Formato de archivo incorrecto', true); }
            };
            reader.readAsText(file);
        }

        // --- GESTI√ìN DE FAVORITOS ---
        function toggleFavorite(gameId) {
            const index = favorites.indexOf(gameId);
            if (index === -1) {
                favorites.push(gameId);
                showToast('A√±adido a favoritos ‚≠ê');
            } else {
                favorites.splice(index, 1);
                showToast('Eliminado de favoritos');
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderGames(); // Re-render to update UI
            if (currentGameData && currentGameData.id === gameId) {
                // Update star in modal if open
                const starBtn = document.querySelector('.favorite-btn-modal');
                if (starBtn) starBtn.innerHTML = getStarIcon(favorites.includes(gameId));
            }
        }

        function getStarIcon(isFav, isModal = false) {
            const size = isModal ? "w-8 h-8" : "w-6 h-6";
            const fill = isFav ? "currentColor" : "none";
            const color = isFav ? "text-yellow-400" : "text-gray-500 hover:text-yellow-400";
            return `<svg xmlns="http://www.w3.org/2000/svg" class="${size} ${color} transition-colors" fill="${fill}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>`;
        }


        // --- FUNCIONES DE UTILIDAD (EXTENDIDAS) ---
        function getVisibleClues(game) {
            if (!game || !game.clues) return [];
            if (game.isSolved) return game.clues;
            const now = new Date();
            return game.clues.filter(clue => clue.publishDate && new Date(clue.publishDate) <= now);
        }

        function normalizeText(text) {
            if (!text) return '';
            return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function copyToClipboard(text, successMsg = '¬°Copiado!') {
            navigator.clipboard.writeText(text).then(() => {
                showToast(successMsg);
            }).catch(err => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try {
                    document.execCommand('copy');
                    showToast(successMsg);
                } catch (e) { showToast('Error al copiar', true); }
                document.body.removeChild(textArea);
            });
        }
        
        // --- FUNCIONES DE RENDERIZADO ---
        function renderSummaryCard(game) {
            const typeData = getTypeData(game.type);
            const difficultyData = getDifficultyData(game.difficulty);
            const statusPill = game.isSolved ? `<span class="bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded-full">Resuelto</span>` : `<span class="bg-yellow-500 text-gray-900 text-xs font-semibold px-2 py-1 rounded-full">En curso</span>`;
            const dateText = game.isSolved ? `Finalizado: ${new Date(game.endDate || game.startDate).toLocaleDateString()}` : `Inicio: ${new Date(game.startDate).toLocaleDateString()}`;
            const isFav = favorites.includes(game.id);

            const card = document.createElement('div');
            card.className = 'bg-gray-800/80 hover:bg-gray-800 transition-colors cursor-pointer rounded-xl shadow-lg p-5 flex flex-col justify-between fade-in relative group';
            card.innerHTML = `
                <button class="absolute top-4 right-4 z-10 favorite-btn p-1" data-id="${game.id}">${getStarIcon(isFav)}</button>
                <div>
                    <div class="flex justify-between items-start mb-3 pr-8">
                        <h3 class="text-xl font-bold text-white truncate">${game.title || 'Misterio sin t√≠tulo'}</h3>
                    </div>
                    <div class="flex items-center flex-wrap gap-2 mb-2">
                        ${statusPill}
                        <span class="text-xs font-bold px-3 py-1 ${typeData.color} text-white rounded-full">${typeData.label}</span>
                        <span class="text-xs font-bold px-3 py-1 ${difficultyData.bgColor} ${difficultyData.textColor} rounded-full">${difficultyData.label} ${difficultyData.emoji}</span>
                    </div>
                    ${game.notes ? `<p class="text-sm text-gray-400 mt-2 line-clamp-2">${game.notes}</p>` : ''}
                </div>
                <div class="mt-4 border-t border-gray-700 pt-3 flex justify-between items-center">
                    <p class="text-xs text-gray-500">${dateText}</p>
                    <p class="text-xs text-gray-500">Pistas: ${getVisibleClues(game).length}/${game.clues.length}</p>
                </div>`;
            
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.favorite-btn')) openModalWithGame(game);
            });
            card.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(game.id);
            });
            return card;
        }

        // Helpers for Type/Difficulty (same as before)
        function getTypeData(type) {
            const map = { 'semanal':{label:'Semanal',color:'bg-blue-600'},'diario':{label:'Diario',color:'bg-yellow-500'},'relampago':{label:'Rel√°mpago',color:'bg-orange-500'},'especial':{label:'Especial',color:'bg-purple-600'},'tutorial':{label:'Tutorial',color:'bg-teal-600'},'default':{label:type||'?',color:'bg-gray-500'} };
            return map[normalizeText(type)] || map['default'];
        }
        function getDifficultyData(d) {
             const map = {'F√°cil':{label:'F√°cil',emoji:'üòá',bgColor:'bg-gray-900',textColor:'text-green-400'},'Medio':{label:'Medio',emoji:'üßê',bgColor:'bg-gray-900',textColor:'text-yellow-400'},'Dif√≠cil':{label:'Dif√≠cil',emoji:'üòà',bgColor:'bg-gray-900',textColor:'text-red-400'},'default':{label:d||'Normal',emoji:'',bgColor:'bg-gray-900',textColor:'text-gray-400'}};
             return map[d] || map['default'];
        }
        function getClueTypeTag(type) {
            const map = {text:{label:'Texto',color:'bg-sky-600'},image:{label:'Imagen',color:'bg-purple-600'},audio:{label:'Audio',color:'bg-pink-600'},video:{label:'V√≠deo',color:'bg-red-600'},link:{label:'Enlace',color:'bg-orange-600'}};
            const c = map[type] || {label:type,color:'bg-gray-600'};
            return `<span class="text-xs font-semibold px-2 py-1 ${c.color} text-white rounded-full">${c.label}</span>`;
        }

        function renderClue(clue, index) {
            let contentHTML = '';
            const textContent = clue.type === 'text' ? clue.content : (clue.text || '');
            if (textContent) contentHTML += `<div class="prose prose-invert max-w-none text-gray-300 mb-4">${textContent.replace(/\n/g, '<br>')}</div>`;
            
            if (clue.type !== 'text' && clue.content) {
                let url = clue.content.startsWith('http') ? clue.content : 'https://' + clue.content;
                if (clue.type === 'image') contentHTML += `<img src="${url}" class="rounded-lg max-h-96 w-auto mx-auto">`;
                else if (clue.type === 'audio') contentHTML += `<audio controls src="${url}" class="w-full"></audio>`;
                else if (clue.type === 'video') contentHTML += `<div class="relative pb-[56.25%]"><iframe src="${url}" class="absolute top-0 left-0 w-full h-full rounded-lg" allowfullscreen></iframe></div>`;
                else if (clue.type === 'link') contentHTML += `<a href="${url}" target="_blank" class="inline-block bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Abrir Enlace</a>`;
            }
            return `<div class="bg-gray-900/50 p-4 rounded-lg flex gap-4"><div class="flex-shrink-0 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center font-bold">${index + 1}</div><div class="flex-grow min-w-0">${contentHTML}</div></div>`;
        }

        function getSolutionHTML(game, revealed = false) {
            const blurClass = revealed ? 'revealed' : '';
            const btnHTML = !revealed ? `<div class="spoiler-overlay"><button class="reveal-spoiler-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg z-20">üëÅÔ∏è Revelar Soluci√≥n</button></div>` : '';
            
            return `
                <div class="mt-8 border-t-2 border-green-500 pt-6 relative">
                    <h3 class="text-2xl font-bold text-green-400 mb-4">Soluci√≥n Final</h3>
                    <div class="relative bg-green-900/30 border border-green-500/50 rounded-xl p-6 text-center overflow-hidden">
                        ${btnHTML}
                        <div class="spoiler-content ${blurClass}">
                            <p class="text-4xl font-extrabold text-white mb-2">${game.solution}</p>
                            ${game.winner ? `<p class="text-yellow-400">¬°Adivinado por <strong>${game.winner}</strong>!</p>` : ''}
                        </div>
                    </div>
                    <div class="prose prose-invert mt-6 spoiler-content ${blurClass}">
                        <h4 class="text-white font-bold">Explicaci√≥n</h4>
                        <p>${(game.explanation || 'Sin explicaci√≥n').replace(/\n/g, '<br>')}</p>
                        ${game.winnerExplanation ? `<h4 class="text-indigo-300 font-bold mt-4">Explicaci√≥n de ${game.winner}</h4><p>${game.winnerExplanation}</p>` : ''}
                    </div>
                </div>`;
        }

        function renderModal(game, view, options = {}) {
            currentGameData = game;
            dom.modalTitle.textContent = game ? game.title : (options.title || '');
            dom.modalBadges.innerHTML = '';
            
            if (game) {
                const isFav = favorites.includes(game.id);
                dom.modalBadges.innerHTML = `
                   <button class="favorite-btn-modal mr-2" onclick="toggleFavorite('${game.id}')">${getStarIcon(isFav, true)}</button>
                   <span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded">${game.type}</span>
                `;
            }

            let contentHTML = '', footerHTML = '';
            const clues = game ? getVisibleClues(game) : [];

            if (view === 'summary') {
                contentHTML = `
                    <div class="space-y-4">
                        ${game.showMystery ? `<div class="bg-gray-700 p-3 rounded text-sm text-gray-300"><strong>Buscamos:</strong> ${game.mystery}</div>` : ''}
                        <p class="text-gray-300 italic">${game.notes || ''}</p>
                        <h4 class="text-indigo-400 font-bold mt-4">√çndice de Pistas</h4>
                        <ul class="space-y-2">
                            ${clues.map((c, i) => `<li><button class="view-clue-btn w-full text-left p-3 rounded hover:bg-gray-700 flex justify-between" data-index="${i}"><span>Pista ${i+1}</span>${getClueTypeTag(c.type)}</button></li>`).join('')}
                        </ul>
                    </div>`;
                footerHTML = `
                    <div class="flex justify-center gap-3 flex-wrap">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded share-btn" data-id="${game.id}">Compartir</button>
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded view-all-btn">Mostrar Todo</button>
                    </div>`;
            } else if (view === 'single-clue') {
                const i = options.clueIndex;
                contentHTML = renderClue(clues[i], i);
                footerHTML = `<button class="back-btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded">Volver</button>`;
            } else if (view === 'all-clues') {
                contentHTML = `<div class="space-y-4">${clues.map((c, i) => renderClue(c, i)).join('')}</div>`;
                if (game.isSolved) contentHTML += getSolutionHTML(game, false); // Default hidden
                footerHTML = `
                    <div class="flex justify-center gap-3 flex-wrap">
                        <button class="back-btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded">Volver</button>
                        ${game.isSolved ? `<button class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded share-btn" data-id="${game.id}">Compartir</button>` : ''}
                        ${!game.isSolved && game.googleFormLink ? `<button class="guess-btn bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded font-bold shadow-lg transform hover:scale-105 transition" data-link="${game.googleFormLink}" data-entry="${game.formEntryId || ''}">¬°Adivina aqu√≠!</button>` : ''}
                    </div>`;
            } else if (view === 'play-solved') {
                const currentClues = clues.slice(0, revealedClueCount);
                contentHTML = `<div class="space-y-4">${currentClues.map((c, i) => renderClue(c, i)).join('')}</div>`;
                if (revealedClueCount < clues.length) {
                    footerHTML = `<div class="flex justify-center"><button class="next-clue-btn bg-indigo-600 text-white py-2 px-4 rounded">Siguiente Pista (${revealedClueCount}/${clues.length})</button></div>`;
                } else {
                    footerHTML = `<div class="flex justify-center"><button class="reveal-final-btn bg-green-600 text-white py-2 px-4 rounded">Ver Soluci√≥n</button></div>`;
                }
            } else if (view === 'info') {
                contentHTML = options.content;
                contentHTML += `<div class="mt-8 border-t border-gray-700 pt-4"><h5 class="font-bold text-gray-400">Registro de Versi√≥n v8.1</h5><ul class="list-disc list-inside text-xs text-gray-500 mt-2"><li>Sistema de Identidad de Usuario persistente.</li><li>Podio global integrado.</li><li>Gesti√≥n de Favoritos (LocalStorage).</li><li>Protecci√≥n contra spoilers en juegos resueltos.</li><li>Autorrelleno seguro de formularios.</li></ul><p class="text-xs text-yellow-600 mt-2">Nota: Los favoritos se guardan en tu navegador. Si limpias cookies, se perder√°n.</p></div>`;
                footerHTML = `<button class="close-modal-btn bg-gray-600 text-white py-2 px-4 rounded">Cerrar</button>`;
            } else if (view === 'pre-solved') {
                contentHTML = `<div class="text-center p-6"><p class="text-lg text-gray-300 mb-6">Este misterio est√° resuelto. ¬øC√≥mo quieres verlo?</p><div class="flex justify-center gap-4"><button id="play-mode-btn" class="bg-indigo-600 text-white py-3 px-6 rounded-lg font-bold">Jugar Pista a Pista</button><button id="view-sol-btn" class="bg-gray-600 text-white py-3 px-6 rounded-lg">Ver Soluci√≥n Directa</button></div></div>`;
            }

            dom.modalContent.innerHTML = contentHTML;
            dom.modalFooter.innerHTML = footerHTML;
            dom.modal.classList.add('active');
        }

        function openModalWithGame(game, view = null, options = {}) {
            let initialView = view || (game.isSolved ? 'pre-solved' : 'summary');
            renderModal(game, initialView, options);
        }

        // --- MANEJO DEL PODIO ---
        async function loadPodium() {
            dom.podiumLoading.classList.remove('hidden');
            dom.podiumError.classList.add('hidden');
            dom.podiumTableBody.innerHTML = '';
            
            try {
                // Fetch simulated/real json
                const response = await fetch(`${LEADERBOARD_PATH}?v=${Date.now()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json(); // Expected: [{userId, name, points, badges:[]}]
                
                // Sort by points desc
                data.sort((a, b) => b.points - a.points);
                
                dom.podiumLoading.classList.add('hidden');
                
                if (data.length === 0) {
                    dom.podiumTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">A√∫n no hay datos en el podio.</td></tr>`;
                    return;
                }

                data.forEach((entry, index) => {
                    const isMe = entry.userId === userId;
                    const rowClass = isMe ? 'bg-indigo-900/40 border-l-4 border-indigo-500' : 'hover:bg-gray-800/50';
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
                    const badges = (entry.badges || []).map(b => `<span class="inline-block bg-gray-700 px-2 py-1 rounded text-xs mr-1">${b}</span>`).join('');
                    
                    const row = `
                        <tr class="${rowClass} transition-colors">
                            <td class="px-6 py-4 font-bold ${index < 3 ? 'text-yellow-400' : 'text-gray-400'}">${medal}</td>
                            <td class="px-6 py-4 font-medium text-white">${entry.name} ${isMe ? '(T√∫)' : ''}</td>
                            <td class="px-6 py-4 text-right font-mono text-indigo-300">${entry.points} pts</td>
                            <td class="px-6 py-4 text-center">${badges}</td>
                        </tr>
                    `;
                    dom.podiumTableBody.insertAdjacentHTML('beforeend', row);
                });
            } catch (error) {
                console.error("Podium Error:", error);
                dom.podiumLoading.classList.add('hidden');
                dom.podiumError.classList.remove('hidden');
            }
        }
        
        function handleUrlSharing() {
            const hash = window.location.hash;
            if (!hash.startsWith('#mystery=')) return;

            const params = new URLSearchParams(hash.substring(1));
            const mysteryId = params.get('mystery');
            const clueIndex = params.get('clue');

            if (mysteryId) {
                const gameToOpen = allGames.find(g => g.id === mysteryId);
                if (gameToOpen) {
                    // Small delay to ensure rendering
                    setTimeout(() => {
                        const view = clueIndex !== null ? 'single-clue' : null;
                        const options = clueIndex !== null ? { clueIndex: parseInt(clueIndex, 10) } : {};
                        openModalWithGame(gameToOpen, view, options);
                    }, 500);
                } else {
                    showToast(`Misterio con ID ${mysteryId} no encontrado.`, true);
                }
            }
        }

        // --- INIT & EVENTS ---
        async function loadGames() {
            try {
                const response = await fetch(`${GAMES_INDEX_PATH}?v=${Date.now()}`);
                if (!response.ok) throw new Error("Index not found");
                const files = await response.json();
                const promises = files.map(f => fetch(`games/${f}?v=${Date.now()}`).then(r => r.json()).catch(e => null));
                const results = await Promise.all(promises);
                allGames = results.filter(Boolean).sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
                renderGames();
                handleUrlSharing();
            } catch (e) {
                dom.enCursoContainer.innerHTML = '<p class="text-red-500">Error cargando juegos.</p>';
            }
        }

        function renderGames() {
            dom.enCursoContainer.innerHTML = '';
            dom.archivoGrid.innerHTML = '';
            
            const search = normalizeText(dom.searchText.value);
            const typeFilter = document.querySelector('#type-filter-container .active').dataset.type;
            const diffFilter = document.querySelector('#difficulty-filter-container .active').dataset.difficulty;
            const onlyFavs = dom.favoritesFilter.checked;
            
            const matches = (g) => {
                if (onlyFavs && !favorites.includes(g.id)) return false;
                if (typeFilter !== 'Todos' && normalizeText(g.type) !== normalizeText(typeFilter)) return false;
                if (diffFilter !== 'Todos' && g.difficulty !== diffFilter) return false;
                if (search) {
                   // B√∫squeda completa (Fix solicitado)
                   const content = normalizeText(`${g.title} ${g.notes} ${g.solution} ${g.explanation || ''} ${g.mystery || ''} ${g.winner || ''} ${g.winnerExplanation || ''}`);
                   if (!content.includes(search)) return false;
                }
                return true;
            };

            const active = allGames.filter(g => !g.isSolved && matches(g));
            const archived = allGames.filter(g => g.isSolved && matches(g));

            if(active.length) active.forEach(g => dom.enCursoContainer.appendChild(renderSummaryCard(g)));
            else dom.enCursoContainer.innerHTML = '<p class="text-gray-500 col-span-2 text-center">No hay misterios activos.</p>';

            if(archived.length) archived.forEach(g => dom.archivoGrid.appendChild(renderSummaryCard(g)));
            else dom.archivoGrid.innerHTML = '<p class="text-gray-500 col-span-2 text-center">No hay misterios en el archivo que coincidan.</p>';
        }

        function initEventListeners() {
            // Tab switching
            dom.tabs.forEach(t => t.addEventListener('click', (e) => {
                dom.tabs.forEach(x => x.classList.remove('active'));
                dom.tabContents.forEach(x => x.classList.add('hidden'));
                e.currentTarget.classList.add('active');
                const target = document.getElementById(e.currentTarget.dataset.tab);
                target.classList.remove('hidden');
                if(e.currentTarget.dataset.tab === 'podio') loadPodium();
            }));
            
            // Explicit Close Button Listener (Fix solicitado)
            dom.modalCloseBtn.addEventListener('click', () => dom.modal.classList.remove('active'));

            // Modal delegation
            dom.modal.addEventListener('click', (e) => {
                if (e.target === dom.modal) { dom.modal.classList.remove('active'); return; }
                const btn = e.target.closest('button');
                if (!btn) return;
                
                if (btn.classList.contains('close-modal-btn')) dom.modal.classList.remove('active');
                if (btn.classList.contains('view-clue-btn')) renderModal(currentGameData, 'single-clue', {clueIndex: btn.dataset.index});
                if (btn.classList.contains('view-all-btn')) renderModal(currentGameData, 'all-clues');
                if (btn.classList.contains('back-btn')) renderModal(currentGameData, 'summary');
                if (btn.classList.contains('share-btn')) copyToClipboard(`${location.origin}${location.pathname}#mystery=${btn.dataset.id}`);
                
                // Play Solved Flow
                if (btn.id === 'play-mode-btn') { revealedClueCount = 1; renderModal(currentGameData, 'play-solved'); }
                if (btn.id === 'view-sol-btn') { renderModal(currentGameData, 'all-clues'); setTimeout(() => document.querySelector('.reveal-spoiler-btn')?.click(), 100); }
                if (btn.classList.contains('next-clue-btn')) { revealedClueCount++; renderModal(currentGameData, 'play-solved'); }
                if (btn.classList.contains('reveal-final-btn')) { renderModal(currentGameData, 'all-clues'); setTimeout(() => document.querySelector('.reveal-spoiler-btn')?.click(), 100); }

                // Spoiler Reveal
                if (btn.classList.contains('reveal-spoiler-btn')) {
                    btn.parentElement.style.display = 'none';
                    document.querySelectorAll('.spoiler-content').forEach(el => el.classList.add('revealed'));
                }

                // GUESS FLOW (Secure)
                if (btn.classList.contains('guess-btn')) {
                    const link = btn.dataset.link;
                    const entryId = btn.dataset.entry;
                    copyToClipboard(userId, '¬°ID Copiado! Pegando en formulario...');
                    let finalUrl = link;
                    if (entryId && userId) {
                        const separator = link.includes('?') ? '&' : '?';
                        finalUrl = `${link}${separator}${entryId}=${userId}`;
                    }
                    pendingRedirectUrl = finalUrl;
                    dom.redirectModalId.textContent = userId;
                    dom.redirectAlertModal.classList.add('active');
                }
            });

            // Redirect Modal
            dom.cancelRedirectBtn.addEventListener('click', () => dom.redirectAlertModal.classList.remove('active'));
            dom.confirmRedirectBtn.addEventListener('click', () => {
                dom.redirectAlertModal.classList.remove('active');
                window.open(pendingRedirectUrl, '_blank');
            });

            // User ID Modal
            dom.userIdDisplay.addEventListener('click', () => dom.userIdModal.classList.add('active'));
            dom.closeUserIdModal.addEventListener('click', () => dom.userIdModal.classList.remove('active'));
            dom.closeUserIdX.addEventListener('click', () => dom.userIdModal.classList.remove('active')); // Fix: Added X listener
            dom.copyIdBtn.addEventListener('click', () => copyToClipboard(userId));
            dom.downloadIdBtn.addEventListener('click', downloadUserId);
            dom.uploadIdBtn.addEventListener('click', () => dom.uploadIdInput.click());
            dom.uploadIdInput.addEventListener('change', handleUploadId);

            // Filters
            dom.searchText.addEventListener('input', renderGames);
            dom.favoritesFilter.addEventListener('change', renderGames);
            document.querySelectorAll('.filter-btn').forEach(b => b.addEventListener('click', (e) => {
                e.target.parentElement.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active'));
                e.target.classList.add('active');
                renderGames();
            }));
            dom.toggleFiltersBtn.addEventListener('click', () => dom.filtersContainer.classList.toggle('hidden'));
            
            // Instructions
            dom.instructionsBtn.addEventListener('click', () => {
                const html = `<div class="prose prose-invert text-gray-300"><h4>C√≥mo Jugar</h4><ol class="list-decimal pl-5 space-y-2"><li>Navega por las pesta√±as <strong>Misterios en Curso</strong> o <strong>Archivo</strong> para encontrar un juego.</li><li>Haz clic en un misterio para ver su resumen. Encontrar√°s una descripci√≥n y un √≠ndice de las pistas disponibles.</li><li>Puedes ver las pistas una por una haciendo clic en el √≠ndice, o todas juntas pulsando <strong>Mostrar Pistas y Resolver</strong>.</li><li>Pulsa <strong>¬°Adivina aqu√≠!</strong>: Tu ID se copiar√° y se rellenar√° autom√°ticamente en el formulario.</li><li>¬°Aseg√∫rate de usar siempre el mismo nombre en el formulario para subir en el Podio!</li><li>Puedes compartir un enlace al misterio o a una pista espec√≠fica usando los botones de compartir.</li><li>Para guardar una copia offline, usa el bot√≥n <strong>Descargar HTML</strong> para obtener un archivo con todas las pistas y la soluci√≥n (si est√° disponible).</li></ol><h4 class="mt-4">Tipos de Misterio</h4><ul class="list-disc pl-5 space-y-2"><li><strong>Semanal:</strong> El formato cl√°sico, con pistas que se revelan a lo largo de la semana.</li><li><strong>Diario/Rel√°mpago:</strong> Misterios m√°s cortos para resolver en menos tiempo.</li><li><strong>Especial:</strong> Eventos tem√°ticos o con reglas diferentes.</li><li><strong>Tutorial:</strong> Misterios dise√±ados para ense√±ar a jugar.</li></ul></div>`;
                renderModal(null, 'info', {title: 'Instrucciones', content: html});
            });

            // Example Game (Fix solicitado)
            if (dom.exampleGameBtn) {
                dom.exampleGameBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch(`${EXAMPLE_GAME_PATH}?v=${Date.now()}`);
                        if (!response.ok) throw new Error(`No se pudo cargar el misterio de ejemplo.`);
                        const exampleGame = await response.json();
                        openModalWithGame(exampleGame);
                    } catch (error) {
                        showToast(error.message, true);
                    }
                });
            }
        }

        // --- START ---
        initUser();
        initEventListeners();
        loadGames();

    </script>
</body>
</html>
