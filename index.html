<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Intersecci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Librer√≠as para el calendario (Flatpickr) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .tab-button.active { background-color: #4f46e5; color: #ffffff; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .modal-content-scroll::-webkit-scrollbar { width: 8px; }
        .modal-content-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .modal-content-scroll::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        
        /* Spoiler blur effect */
        .spoiler-blur { filter: blur(6px); user-select: none; pointer-events: none; transition: filter 0.5s ease; }
        .spoiler-revealed { filter: blur(0); user-select: auto; pointer-events: auto; }

        #toast-notification {
            position: fixed;
            bottom: -100px;
            right: 20px;
            background-color: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast-notification.show { bottom: 20px; }
        .filter-btn { background-color: #374151; }
        .filter-btn.active { background-color: #4f46e5; }
        
        /* Flatpickr dark mode overrides */
        .flatpickr-calendar.dark { background: #1f2937; border-color: #374151; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .flatpickr-calendar.dark .flatpickr-month, .flatpickr-calendar.dark .flatpickr-weekday, .flatpickr-calendar.dark .flatpickr-day { color: #d1d5db; }
        .flatpickr-calendar.dark .flatpickr-day.today { border-color: #4f46e5; }
        .flatpickr-calendar.dark .flatpickr-day.selected, .flatpickr-calendar.dark .flatpickr-day.startRange, .flatpickr-calendar.dark .flatpickr-day.endRange { background: #4f46e5; border-color: #4f46e5; color: #fff; }
        .flatpickr-calendar.dark .flatpickr-day:hover { background: #374151; }
        .flatpickr-calendar.dark .flatpickr-day.inRange { background: rgba(79, 70, 229, 0.2); box-shadow: none; border-color: transparent; }
        .flatpickr-calendar.dark .numInput, .flatpickr-calendar.dark .arrowUp, .flatpickr-calendar.dark .arrowDown { color: #d1d5db; }
    </style>
</head>
<body class="text-gray-200">
    <!-- Navegaci√≥n Superior -->
    <div class="fixed top-4 right-4 z-40">
        <button id="my-id-btn" class="bg-indigo-900/80 hover:bg-indigo-800 backdrop-blur-sm text-indigo-200 font-semibold py-2 px-4 rounded-full shadow-lg border border-indigo-500/30 transition flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
            Mi ID
        </button>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl pt-16">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">La Intersecci√≥n</h1>
            <p class="mt-2 text-lg text-gray-400">Un juego de misterios semanales.</p>
        </header>

        <nav class="flex justify-center border-b border-gray-700 mb-8 overflow-x-auto">
            <button data-tab="en-curso" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition active whitespace-nowrap">Misterios en Curso</button>
            <button data-tab="archivo" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition whitespace-nowrap">Archivo</button>
            <button data-tab="podio" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition whitespace-nowrap flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5c0 .538-.012 1.05-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33.076 33.076 0 0 1 2.5.5zm.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935zm10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.885-.72 3.935zM3.504 1c.007.517.026 1.006.056 1.469.13 2.028.457 3.546.87 4.667C5.294 9.48 6.484 10 7 10a.5.5 0 0 1 0 1c-.618 0-1.62-.546-2.553-2.503-.128-.268-.246-.566-.352-.89v-.001C3.862 6.379 3.548 4.673 3.504 1zm7.992 9.003C10.596 9.455 9.612 10 9 10a.5.5 0 0 1 0-1c.516 0 1.706-.52 2.574-2.864.413-1.12.74-2.64.87-4.667.03-.463.049-.952.056-1.469-.044 3.673-.358 5.379-.593 6.611-.106.323-.224.62-.352.89z"/></svg> Podio
            </button>
            <button data-tab="sobre" class="tab-button text-gray-300 hover:bg-gray-700/50 font-semibold py-3 px-6 transition whitespace-nowrap">Sobre el Proyecto</button>
        </nav>

        <main>
            <div id="en-curso" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-6 min-h-[100px]"></div>
            
            <div id="archivo" class="tab-content hidden min-h-[100px] relative">
                 <!-- Bot√≥n para mostrar/ocultar filtros -->
                <div class="flex justify-between items-center mb-4">
                     <button id="toggle-favorites-btn" class="bg-gray-800 hover:bg-yellow-900/30 text-yellow-500 font-semibold py-2 px-4 rounded-lg transition-all flex items-center gap-2 border border-yellow-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>
                        <span id="toggle-favorites-text">Solo Favoritos</span>
                    </button>
                    <button id="toggle-filters-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                        <span>Filtros</span>
                    </button>
                </div>
                <!-- Contenedor de filtros -->
                <div id="filters-container" class="hidden mb-6 bg-gray-800/50 p-4 rounded-xl fade-in space-y-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="relative flex-grow">
                            <input type="text" id="search-text" placeholder="Buscar..." class="w-full bg-gray-700 border-gray-600 rounded-lg p-3 pl-10 focus:ring-2 focus:ring-indigo-500 transition border">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="date-filter-container">
                            <input type="text" id="search-date" placeholder="Filtrar por fecha" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                        </div>
                    </div>
                    <div id="type-filter-container" class="flex flex-wrap items-center gap-2">
                        <span class="text-sm font-medium text-gray-400 mr-2">Tipo:</span>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors active" data-type="Todos">Todos</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Semanal">Semanal</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Diario">Diario</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Rel√°mpago">Rel√°mpago</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Especial">Especial</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-type="Tutorial">Tutorial</button>
                    </div>
                    <div id="difficulty-filter-container" class="flex flex-wrap items-center gap-2">
                        <span class="text-sm font-medium text-gray-400 mr-2">Dificultad:</span>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors active" data-difficulty="Todos">Todos</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-difficulty="F√°cil">F√°cil üòá</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-difficulty="Medio">Medio üßê</button>
                        <button class="filter-btn text-sm font-semibold py-2 px-4 rounded-full transition-colors" data-difficulty="Dif√≠cil">Dif√≠cil üòà</button>
                    </div>
                </div>
                <div id="archivo-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <div id="podio" class="tab-content hidden relative">
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 fade-in">
                    <h2 class="text-3xl font-bold text-yellow-400 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5c0 .538-.012 1.05-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33.076 33.076 0 0 1 2.5.5z"/></svg>
                        Podio de Sabios
                    </h2>
                    <p class="text-gray-400 mb-6">Los mejores investigadores de La Intersecci√≥n. ¬°Participa en los misterios en curso para sumar puntos!</p>
                    <div id="leaderboard-container" class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-gray-700 text-gray-400 uppercase text-xs">
                                    <th class="py-3 px-4">#</th>
                                    <th class="py-3 px-4 w-full">Nombre</th>
                                    <th class="py-3 px-4 text-right">Puntos</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body" class="text-gray-200">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                        <p id="loading-leaderboard" class="text-center py-8 text-gray-500">Cargando clasificaci√≥n...</p>
                    </div>
                </div>
            </div>

            <div id="sobre" class="tab-content hidden relative pb-8">
                 <div class="space-y-8 fade-in">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-8">
                        <h2 class="text-3xl font-bold text-indigo-400 mb-4">¬øQu√© es "La Intersecci√≥n"?</h2>
                        <p class="text-gray-300 leading-relaxed">Este es un peque√±o proyecto de entretenimiento inspirado en el famoso concurso "Saber y Ganar". El objetivo es adivinar "la intersecci√≥n" ‚Äîque puede ser una persona, un lugar, una pel√≠cula, una canci√≥n o cualquier cosa imaginable‚Äî a partir de peque√±as pistas que se ir√°n revelando semanalmente. Es un reto a la paciencia, la deducci√≥n y la cultura general.</p>
                    </div>
                    <div class="grid md:grid-cols-5 gap-8">
                        <div class="md:col-span-3 bg-gray-800 rounded-xl shadow-lg p-8">
                            <h3 class="text-2xl font-bold text-indigo-400 mb-6">¬øC√≥mo se juega?</h3>
                            <ol class="space-y-5">
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">1</div><div class="pt-1">Visita la pesta√±a <strong>Misterios en Curso</strong> o el <strong>Archivo</strong> para elegir un juego.</div></li>
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">2</div><div class="pt-1">Si est√° resuelto, puedes elegir entre ver la soluci√≥n directamente o jugar pista a pista.</div></li>
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">3</div><div class="pt-1">Cuando creas tener la soluci√≥n, pulsa <strong>¬°Adivina aqu√≠!</strong>. Tu ID se copiar√° autom√°ticamente para que lo pegues en el formulario.</div></li>
                                <li class="flex"><div class="flex-shrink-0 bg-indigo-600 rounded-full text-white font-bold w-8 h-8 flex items-center justify-center mr-4">4</div><div class="pt-1">¬°Suma puntos y escala posiciones en el <strong>Podio</strong>!</div></li>
                            </ol>
                             <div class="mt-8 text-center">
                                <button id="instructions-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105">Instrucciones detalladas</button>
                            </div>
                        </div>
                        <div class="md:col-span-2 bg-gray-800 rounded-xl shadow-lg p-8 flex flex-col">
                             <h3 class="text-2xl font-bold text-indigo-400 mb-6">Contacto y Opiniones</h3>
                             <div class="space-y-4 flex-grow flex flex-col justify-center">
                                <a href="https://www.instagram.com/interseccion_juego?igsh=MWw5c3YxYXcwa3Vmbg==" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-4 bg-gray-700/50 hover:bg-gray-700 p-4 rounded-lg transition-all">
                                     <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-purple-600 via-pink-600 to-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.917 3.917 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zM8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm0 1.442a2.558 2.558 0 1 0 0 5.116 2.558 2.558 0 0 0 0-5.116z"/></svg></div>
                                     <div><div class="font-bold text-white">Instagram</div><div class="text-sm text-gray-400 group-hover:text-gray-200 transition">Sigue el juego</div></div>
                                 </a>
                                 <a href="https://forms.gle/CTqcoBsGsf2kX1WKA" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-4 bg-gray-700/50 hover:bg-gray-700 p-4 rounded-lg transition-all">
                                     <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center bg-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="text-white" viewBox="0 0 16 16"><path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 0 1.5H4.5A1 1 0 0 0 3.5 3h10a1 1 0 0 0 1-1 .75.75 0 0 1 1.5 0v1A1.5 1.5 0 0 1 14.5 4h-13A1.5 1.5 0 0 1 0 2.5v-1A1.5 1.5 0 0 1 1.5 0H2z"/><path d="M16 5.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 5.5v-1A1.5 1.5 0 0 1 1.5 3H2a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1h.5a1.5 1.5 0 0 1 1.5 1.5v1zM1.5 9h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1zm0 2.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1z"/></svg></div>
                                     <div><div class="font-bold text-white">Dame tu opini√≥n</div><div class="text-sm text-gray-400 group-hover:text-gray-200 transition">Formulario de feedback</div></div>
                                 </a>
                                 <button id="example-game-btn" class="group flex items-center gap-4 bg-gray-700/50 hover:bg-gray-700 p-4 rounded-lg transition-all w-full text-left">
                                     <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center bg-teal-500"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="text-white" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg></div>
                                     <div><div class="font-bold text-white">Misterio de Ejemplo</div><div class="text-sm text-gray-400 group-hover:text-gray-200 transition">Prueba el juego</div></div>
                                 </button>
                             </div>
                        </div>
                    </div>
                 </div>
                 <div class="absolute bottom-2 right-2 text-xs text-gray-600">v8.0</div>
            </div>
        </main>
    </div>

    <!-- Modal del Juego -->
    <div id="game-modal" class="modal fixed inset-0 bg-black bg-opacity-80 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                <div class="flex-grow min-w-0">
                    <h2 id="modal-title" class="text-2xl font-bold text-white truncate"></h2>
                    <div id="modal-badges" class="flex items-center gap-2 mt-1"></div>
                </div>
                <button id="modal-close-btn" class="flex-shrink-0 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </header>
            <div id="modal-content" class="p-6 overflow-y-auto modal-content-scroll"></div>
            <footer id="modal-footer" class="flex-shrink-0 p-4 border-t border-gray-700"></footer>
        </div>
    </div>
    
    <!-- Modal de Identidad -->
    <div id="id-modal" class="modal fixed inset-0 bg-black bg-opacity-80 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 border border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="text-indigo-500" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
                Tu Identidad de Jugador
            </h2>
            <div class="bg-indigo-900/30 border border-indigo-500/50 rounded-lg p-4 mb-6 text-center">
                <p class="text-gray-400 text-sm mb-1">Tu ID √önico es:</p>
                <p id="user-id-display" class="text-2xl font-mono font-bold text-white tracking-wider select-all"></p>
            </div>
            <div class="bg-yellow-900/30 border-l-4 border-yellow-500 p-4 mb-6">
                <p class="text-sm text-yellow-200"><strong>¬°Advertencia!</strong> Si limpias las cookies de tu navegador, perder√°s este ID y tu progreso. Gu√°rdalo descargando el archivo a continuaci√≥n.</p>
            </div>
             <div class="bg-gray-700/50 p-4 rounded-lg mb-6">
                <p class="text-sm text-gray-300 mb-2"><strong>Advertencia sobre Favoritos:</strong> Tus favoritos se guardan localmente. Si borras cookies, desaparecer√°n.</p>
            </div>
            <div class="flex flex-col gap-3">
                <button id="download-id-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition text-center flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                    Descargar Copia de Seguridad
                </button>
                <div class="relative">
                     <input type="file" id="upload-id-input" accept=".html" class="hidden">
                     <button id="upload-id-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-3 px-4 rounded-lg transition text-center border border-gray-600">
                        Restaurar ID desde Archivo
                     </button>
                </div>
                <button id="close-id-modal-btn" class="mt-2 text-gray-500 hover:text-white font-medium py-2">Cerrar</button>
            </div>
        </div>
    </div>

     <!-- Modal Alerta Redirect -->
    <div id="redirect-modal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-[60]">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 border border-gray-600">
            <h3 class="text-xl font-bold text-white mb-4">Enviando tu respuesta...</h3>
            <p class="text-gray-300 mb-4">Vamos a redirigirte al formulario. Hemos copiado tu ID al portapapeles y tambi√©n intentaremos rellenarlo autom√°ticamente.</p>
            <div class="bg-indigo-900/50 p-3 rounded mb-4">
                 <p class="text-sm text-indigo-200">Tu ID: <span id="redirect-modal-id" class="font-mono font-bold"></span></p>
            </div>
            <p class="text-gray-400 text-sm mb-6"><strong>Importante:</strong> Aseg√∫rate de escribir el nombre con el que quieres aparecer en el Podio en el campo correspondiente del formulario.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-redirect-btn" class="text-gray-400 hover:text-white px-4 py-2 font-semibold">Cancelar</button>
                <button id="confirm-redirect-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">Ir al Formulario</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification"></div>

    <script>
        const dom = {
            tabs: document.querySelectorAll('.tab-button'), tabContents: document.querySelectorAll('.tab-content'), enCursoContainer: document.getElementById('en-curso'), archivoContainer: document.getElementById('archivo'), archivoGrid: document.getElementById('archivo-grid'),
            modal: document.getElementById('game-modal'), modalTitle: document.getElementById('modal-title'), modalContent: document.getElementById('modal-content'), modalFooter: document.getElementById('modal-footer'), modalCloseBtn: document.getElementById('modal-close-btn'), modalBadges: document.getElementById('modal-badges'),
            searchText: document.getElementById('search-text'),
            searchDate: document.getElementById('search-date'),
            typeFilterContainer: document.getElementById('type-filter-container'),
            difficultyFilterContainer: document.getElementById('difficulty-filter-container'),
            toggleFiltersBtn: document.getElementById('toggle-filters-btn'),
            filtersContainer: document.getElementById('filters-container'),
            instructionsBtn: document.getElementById('instructions-btn'),
            
            // Favorites
            toggleFavoritesBtn: document.getElementById('toggle-favorites-btn'),
            toggleFavoritesText: document.getElementById('toggle-favorites-text'),
            
            // Identity
            myIdBtn: document.getElementById('my-id-btn'),
            idModal: document.getElementById('id-modal'),
            userIdDisplay: document.getElementById('user-id-display'),
            downloadIdBtn: document.getElementById('download-id-btn'),
            uploadIdInput: document.getElementById('upload-id-input'),
            uploadIdBtn: document.getElementById('upload-id-btn'),
            closeIdModalBtn: document.getElementById('close-id-modal-btn'),

            // Redirect
            redirectModal: document.getElementById('redirect-modal'),
            redirectModalId: document.getElementById('redirect-modal-id'),
            confirmRedirectBtn: document.getElementById('confirm-redirect-btn'),
            cancelRedirectBtn: document.getElementById('cancel-redirect-btn'),
            
            // Podium
            leaderboardBody: document.getElementById('leaderboard-body'),
            loadingLeaderboard: document.getElementById('loading-leaderboard'),
        };

        const GAMES_INDEX_PATH = 'games/index.json';
        const EXAMPLE_GAME_PATH = 'games/ejemplo_resuelto.json'; 
        const LEADERBOARD_PATH = 'leaderboard.json';
        
        let allGames = [];
        let datePicker;
        let currentGameData = null;
        let revealedClueCount = 0;
        let userId = null;
        let favorites = [];
        let pendingRedirectUrl = '';
        let showFavoritesOnly = false;

        // --- GESTI√ìN DE IDENTIDAD (UUID) ---

        function initIdentity() {
            const storedId = localStorage.getItem('interseccion_user_id');
            if (storedId) {
                userId = storedId;
            } else {
                userId = crypto.randomUUID();
                localStorage.setItem('interseccion_user_id', userId);
                // Si es nuevo usuario, quiz√°s mostrar modal (opcional, aqu√≠ solo bot√≥n)
                // dom.idModal.classList.add('active'); 
            }
            dom.userIdDisplay.textContent = userId;
        }

        function downloadIdFile() {
            const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head><meta charset="UTF-8"><title>Copia de Seguridad ID - La Intersecci√≥n</title></head>
<body style="background:#111827;color:#fff;font-family:sans-serif;text-align:center;padding:50px;">
    <h1>La Intersecci√≥n</h1>
    <p>Esta es tu llave de acceso.</p>
    <div style="background:#374151;padding:20px;margin:20px auto;max-width:400px;border-radius:10px;">
        <h2>Tu ID:</h2>
        <code style="font-size:1.5em;color:#818cf8;">${userId}</code>
    </div>
    <p>Sube este archivo en la web para restaurar tu progreso.</p>
    <!-- DATA_ID_DO_NOT_MODIFY: ${userId} -->
    <div id="hidden-id-data" style="display:none;">${userId}</div>
</body>
</html>`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mi_id_interseccion.html`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Archivo de ID descargado');
        }

        function handleIdUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                // Intentar extraer el ID del div oculto
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const extractedId = doc.getElementById('hidden-id-data')?.textContent;

                if (extractedId && extractedId.length > 20) { // Validaci√≥n simple de longitud UUID
                    userId = extractedId.trim();
                    localStorage.setItem('interseccion_user_id', userId);
                    dom.userIdDisplay.textContent = userId;
                    showToast('¬°ID restaurado con √©xito!');
                    dom.idModal.classList.remove('active');
                    loadPodium(); // Recargar podio para resaltar el nuevo ID
                } else {
                    showToast('Error: No se encontr√≥ un ID v√°lido en el archivo.', true);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // --- GESTI√ìN DE FAVORITOS ---

        function initFavorites() {
            const storedFavs = localStorage.getItem('interseccion_favorites');
            if (storedFavs) {
                try { favorites = JSON.parse(storedFavs); } catch(e) { favorites = []; }
            }
        }

        function toggleFavorite(gameId) {
            if (favorites.includes(gameId)) {
                favorites = favorites.filter(id => id !== gameId);
                showToast('Eliminado de favoritos');
            } else {
                favorites.push(gameId);
                showToast('A√±adido a favoritos');
            }
            localStorage.setItem('interseccion_favorites', JSON.stringify(favorites));
            renderGames(); // Re-renderizar lista
            if (currentGameData && currentGameData.id === gameId) {
                 openModalWithGame(currentGameData, null); // Refrescar modal si est√° abierto
            }
        }

        // --- PODIO ---

        async function loadPodium() {
            dom.loadingLeaderboard.classList.remove('hidden');
            dom.leaderboardBody.innerHTML = '';
            try {
                const response = await fetch(`${LEADERBOARD_PATH}?v=${Date.now()}`);
                if (!response.ok) throw new Error('No hay datos del podio a√∫n.');
                const data = await response.json();
                
                dom.loadingLeaderboard.classList.add('hidden');
                
                if (!Array.isArray(data) || data.length === 0) {
                     dom.leaderboardBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">A√∫n no hay registros en el podio.</td></tr>';
                     return;
                }

                data.sort((a, b) => b.points - a.points); // Asegurar orden

                data.forEach((entry, index) => {
                    const isCurrentUser = entry.id === userId;
                    const row = document.createElement('tr');
                    row.className = `border-b border-gray-700 hover:bg-gray-700/30 transition ${isCurrentUser ? 'bg-indigo-900/40 border-indigo-500' : ''}`;
                    
                    // Medallas para top 3
                    let rankDisplay = `<span class="font-mono text-gray-400">#${index + 1}</span>`;
                    if (index === 0) rankDisplay = 'ü•á';
                    if (index === 1) rankDisplay = 'ü•à';
                    if (index === 2) rankDisplay = 'ü•â';

                    row.innerHTML = `
                        <td class="py-3 px-4 text-lg">${rankDisplay}</td>
                        <td class="py-3 px-4 font-medium ${isCurrentUser ? 'text-indigo-300 font-bold' : 'text-gray-300'}">
                            ${entry.name} ${isCurrentUser ? '<span class="ml-2 text-xs bg-indigo-600 text-white px-2 py-0.5 rounded-full">T√∫</span>' : ''}
                        </td>
                        <td class="py-3 px-4 text-right font-bold text-yellow-500">${entry.points}</td>
                    `;
                    dom.leaderboardBody.appendChild(row);
                });

            } catch (error) {
                console.warn(error);
                dom.loadingLeaderboard.textContent = "El Podio se est√° construyendo. Vuelve pronto.";
            }
        }


        // --- FUNCIONES DE UTILIDAD EXISTENTES MODIFICADAS ---

        function getVisibleClues(game) {
            if (!game || !game.clues) return [];
            if (game.isSolved) return game.clues;
            const now = new Date();
            return game.clues.filter(clue => clue.publishDate && new Date(clue.publishDate) <= now);
        }

        function normalizeText(text) {
            if (!text) return '';
            return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                document.execCommand('copy');
                // showToast('Copiado al portapapeles'); // Gestionado individualmente
            } catch (err) {
                showToast('Error al copiar', true);
            }
            document.body.removeChild(textArea);
        }

        function getOrdinal(n) {
            const ordinals = ["Primera", "Segunda", "Tercera", "Cuarta", "Quinta", "Sexta", "S√©ptima", "Octava", "Novena", "D√©cima"];
            return (n > 0 && n <= ordinals.length) ? ordinals[n - 1] : `${n}¬™`;
        }

        function getTypeData(type) {
            const normalizedType = normalizeText(type);
            const typeMap = {
                'semanal':   { label: 'Semanal',   color: 'bg-blue-600' },
                'diario':    { label: 'Diario',    color: 'bg-yellow-500' },
                'relampago': { label: 'Rel√°mpago', color: 'bg-orange-500' },
                'especial':  { label: 'Especial',  color: 'bg-purple-600' },
                'tutorial':  { label: 'Tutorial',  color: 'bg-teal-600' },
                'default':   { label: type || 'Desconocido', color: 'bg-gray-500' }
            };
            return typeMap[normalizedType] || typeMap['default'];
        }

        function getDifficultyData(difficulty) {
            const difficultyMap = {
                'F√°cil':   { label: 'F√°cil',   emoji: 'üòá', bgColor: 'bg-gray-900', textColor: 'text-green-400' },
                'Medio':   { label: 'Medio',   emoji: 'üßê', bgColor: 'bg-gray-900', textColor: 'text-yellow-400' },
                'Dif√≠cil': { label: 'Dif√≠cil', emoji: 'üòà', bgColor: 'bg-gray-900', textColor: 'text-red-400' },
                'default': { label: difficulty || 'Normal',  emoji: '',   bgColor: 'bg-gray-900',   textColor: 'text-gray-400' }
            };
            return difficultyMap[difficulty] || difficultyMap['default'];
        }

        function getClueTypeTag(type) {
             const typeMap = {
                text: { label: 'Texto', color: 'bg-sky-600' },
                image: { label: 'Imagen', color: 'bg-purple-600' },
                audio: { label: 'Audio', color: 'bg-pink-600' },
                video: { label: 'V√≠deo', color: 'bg-red-600' },
                link: { label: 'Enlace', color: 'bg-orange-600' }
            };
            const config = typeMap[type] || { label: type, color: 'bg-gray-600' };
            return `<span class="text-xs font-semibold px-2 py-1 ${config.color} text-white rounded-full">${config.label}</span>`;
        }

        // --- RENDERIZADO MODIFICADO ---

        function renderSummaryCard(game) {
            const typeData = getTypeData(game.type);
            const difficultyData = getDifficultyData(game.difficulty);
            const statusPill = game.isSolved ? `<span class="bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded-full">Resuelto</span>` : `<span class="bg-yellow-500 text-gray-900 text-xs font-semibold px-2 py-1 rounded-full">En curso</span>`;
            const isFav = favorites.includes(game.id);
            
            const card = document.createElement('div');
            card.className = 'bg-gray-800/80 hover:bg-gray-800 transition-colors cursor-pointer rounded-xl shadow-lg p-5 flex flex-col justify-between fade-in relative group';
            
            // Bot√≥n Favorito en la tarjeta
            card.innerHTML = `
                <button class="fav-btn absolute top-4 right-4 text-gray-500 hover:text-yellow-400 transition z-10 p-1" data-id="${game.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" class="${isFav ? 'text-yellow-400' : ''}" viewBox="0 0 16 16">
                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                    </svg>
                </button>
                <div>
                    <div class="flex justify-between items-start mb-3 pr-8">
                        <h3 class="text-xl font-bold text-white">${game.title || 'Misterio'}</h3>
                    </div>
                    <div class="flex items-center flex-wrap gap-2 mb-2">
                        ${statusPill}
                        <span class="text-xs font-bold px-3 py-1 ${typeData.color} text-white rounded-full">${typeData.label}</span>
                        <span class="text-xs font-bold px-3 py-1 ${difficultyData.bgColor} ${difficultyData.textColor} rounded-full">${difficultyData.label} ${difficultyData.emoji}</span>
                    </div>
                    ${game.notes ? `<p class="text-sm text-gray-400 mt-2 italic line-clamp-2">${game.notes}</p>` : ''}
                </div>
                <div class="mt-4 border-t border-gray-700 pt-3 flex justify-between items-end">
                    <p class="text-xs text-gray-500">${game.startDate ? new Date(game.startDate).toLocaleDateString('es-ES') : ''}</p>
                    <p class="text-sm text-indigo-400 font-medium">Pistas: ${getVisibleClues(game).length}/${game.clues.length}</p>
                </div>`;
            
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.fav-btn')) openModalWithGame(game);
            });
            
            // Evento Fav
            card.querySelector('.fav-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(game.id);
            });

            return card;
        }

        function renderClue(clue, index) {
            let mainTextHTML = '', mediaHTML = '';
            const textContent = clue.type === 'text' ? clue.content : (clue.text || '');
            if (textContent) {
                mainTextHTML = `<div class="prose prose-invert max-w-none prose-p:text-gray-300 prose-p:my-0">${textContent.replace(/\n/g, '<br>')}</div>`;
            }

            if (clue.type !== 'text' && clue.content) {
                let url = clue.content;
                if (!/^https?:\/\//i.test(url)) { url = 'https://' + url; }
                
                switch (clue.type) {
                    case 'image': mediaHTML = `<img src="${url}" alt="Pista de imagen" class="mt-4 rounded-lg w-full h-auto object-contain max-h-96">`; break;
                    case 'audio': mediaHTML = `<audio controls src="${url}" class="mt-4 w-full"></audio>`; break;
                    case 'video': mediaHTML = `<div class="relative mt-4" style="padding-bottom: 56.25%"><iframe src="${url}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-lg"></iframe></div>`; break;
                    case 'link': mediaHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer" class="mt-4 inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/></svg><span>Abrir Enlace</span></a>`; break;
                }
            }
            return `<div class="flex items-start gap-4 p-4 bg-gray-900/50 rounded-lg"><div class="flex-shrink-0 bg-indigo-600 h-8 w-8 rounded-full flex items-center justify-center font-bold text-white text-sm">${index + 1}</div><div class="flex-grow min-w-0">${mainTextHTML}${mediaHTML}</div></div>`;
        }

        // --- SISTEMA DE SPOILER ---
        function getSolutionHTML(game, revealed = false) {
            const explanationHTML = game.explanation ? `<p>${game.explanation.replace(/\n/g, '<br>')}</p>` : '<p>No se proporcion√≥ una explicaci√≥n.</p>';
            const winnerExplanationHTML = game.winnerExplanation ? `<h4 class="text-xl font-semibold text-indigo-300 mt-8 mb-2">Explicaci√≥n de ${game.winner || 'N/A'}</h4><div class="prose prose-invert max-w-none prose-p:text-gray-400">${game.winnerExplanation.replace(/\n/g, '<br>')}</div>` : '';
            
            // Spoiler Logic
            const spoilerClass = revealed ? 'spoiler-revealed' : 'spoiler-blur';
            const buttonHTML = revealed ? '' : `<div class="absolute inset-0 flex items-center justify-center z-10"><button id="reveal-spoiler-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full shadow-xl border border-gray-600 transition transform hover:scale-105">üëÅÔ∏è Revelar Soluci√≥n</button></div>`;

            return `<div class="mt-6 border-t-2 border-green-500 pt-6 space-y-4 relative">
                        <h3 class="text-2xl font-bold text-green-400">Soluci√≥n Final</h3>
                        
                        <div class="relative min-h-[150px]">
                            ${buttonHTML}
                            <div id="spoiler-content" class="${spoilerClass} bg-green-900/50 border border-green-500 rounded-lg p-6 text-center transition-all duration-500">
                                <p class="text-4xl font-extrabold text-white break-words">${game.solution || 'N/A'}</p>
                                ${game.winner ? `<p class="text-lg text-yellow-400 mt-2">¬°Adivinado por <strong>${game.winner}</strong>!</p>` : ''}
                                <div class="prose prose-invert max-w-none prose-p:text-gray-300 prose-headings:text-white mt-6 text-left">
                                    <h4 class="text-2xl font-bold text-white mb-2">Explicaci√≥n</h4>
                                    ${explanationHTML}
                                    ${winnerExplanationHTML}
                                </div>
                            </div>
                        </div>
                    </div>`;
        }

        function renderModal(game, view = 'summary', options = {}) {
            currentGameData = game;
            dom.modalTitle.textContent = game ? (game.title || 'Misterio') : (options.title || 'Informaci√≥n');
            dom.modalBadges.innerHTML = '';
            
            if (game) {
                const typeData = getTypeData(game.type);
                const difficultyData = getDifficultyData(game.difficulty);
                const isFav = favorites.includes(game.id);
                
                dom.modalBadges.innerHTML = `
                    <span class="text-xs font-bold px-3 py-1 ${typeData.color} text-white rounded-full">${typeData.label}</span>
                    <span class="text-xs font-bold px-3 py-1 ${difficultyData.bgColor} ${difficultyData.textColor} rounded-full">${difficultyData.label} ${difficultyData.emoji}</span>
                    <button class="modal-fav-btn ml-2 text-gray-400 hover:text-yellow-400 transition" data-id="${game.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" class="${isFav ? 'text-yellow-400' : ''}" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>
                    </button>
                `;
                
                // Add event listener for modal fav btn
                setTimeout(() => {
                    const favBtn = dom.modalBadges.querySelector('.modal-fav-btn');
                    if(favBtn) favBtn.addEventListener('click', () => { toggleFavorite(game.id); });
                }, 0);
            }

            let contentHTML = '';
            let footerHTML = '';
            const availableClues = game ? getVisibleClues(game) : [];

            switch(view) {
                case 'summary':
                    const cluesIndex = availableClues.length > 0 ? `
                        <div class="mt-6">
                            <h4 class="text-xl font-bold text-indigo-400">√çndice de Pistas</h4>
                            <ul class="space-y-2 mt-3 text-gray-300">
                                ${availableClues.map((clue, index) => `
                                    <li>
                                        <a href="#" class="view-clue-btn flex justify-between items-center w-full hover:bg-gray-700/50 p-3 rounded-lg transition-colors" data-clue-index="${index}">
                                            <span class="font-semibold">${getOrdinal(index + 1)} pista</span>
                                            ${getClueTypeTag(clue.type)}
                                        </a>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '<p class="text-gray-500 mt-4">A√∫n no hay pistas disponibles.</p>';

                    contentHTML = `
                        <div class="space-y-4">
                            ${game.showMystery && game.mystery ? `<div class="bg-gray-700/50 p-4 rounded-lg"><p class="text-sm text-gray-400"><strong>Lo que buscamos es:</strong> ${game.mystery}</p></div>` : ''}
                            <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                                <p class="text-gray-300">${game.notes || 'Descripci√≥n del misterio...'}</p>
                            </div>
                            ${cluesIndex}
                        </div>`;
                    
                    footerHTML = `
                        <div class="flex flex-wrap justify-center gap-4">
                            <button class="share-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-game-id="${game.id}">Compartir</button>
                            <button class="view-all-clues-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Mostrar Pistas y Resolver</button>
                        </div>`;
                    break;

                case 'all-clues':
                    const allCluesHTML = availableClues.map((clue, i) => renderClue(clue, i)).join('');
                    const solutionHTML = game.isSolved ? getSolutionHTML(game, false) : ''; // Start blurred
                    contentHTML = `<div class="space-y-4">${allCluesHTML}${solutionHTML}</div>`;

                    footerHTML = `
                        <div class="flex flex-wrap justify-center gap-4">
                            <button class="back-to-summary-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Volver Atr√°s</button>
                            <button class="download-html-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Descargar pistas</button>
                            ${game.googleFormLink && !game.isSolved ? `<button class="guess-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform hover:scale-105 transition" data-link="${game.googleFormLink}" data-entry-id="${game.formEntryId || ''}">¬°Adivina aqu√≠!</button>` : ''}
                        </div>`;
                    break;
                
                case 'single-clue':
                    const clueIndex = options.clueIndex;
                    if (clueIndex >= 0 && clueIndex < availableClues.length) {
                        const clue = availableClues[clueIndex];
                        contentHTML = renderClue(clue, clueIndex);
                        footerHTML = `
                        <div class="flex flex-wrap justify-center gap-4">
                            <button class="back-to-summary-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Volver al √çndice</button>
                            <button class="share-clue-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-game-id="${game.id}" data-clue-index="${clueIndex}">Compartir</button>
                        </div>`;
                    } else { contentHTML = `<p class="text-red-400">Error: Pista no encontrada.</p>`; footerHTML = `<button class="back-to-summary-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Volver al √çndice</button>`; }
                    break;
                
                 case 'pre-solved':
                    contentHTML = `<div class="text-center space-y-4 p-4"><p>Este misterio ya ha sido resuelto.</p><div class="flex flex-col sm:flex-row justify-center gap-4"><button id="play-solved-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg">Jugar pista a pista</button><button id="show-solution-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Ver Soluci√≥n Directamente</button></div></div>`;
                    footerHTML = '';
                    break;
                
                case 'play-solved':
                    const cluesToShow = availableClues.slice(0, revealedClueCount);
                    const playingCluesHTML = cluesToShow.map((clue, i) => renderClue(clue, i)).join('');
                    contentHTML = `<div class="space-y-4">${playingCluesHTML}</div>`;
                    
                    let playFooterHTML = '';
                    if(revealedClueCount < availableClues.length) {
                        playFooterHTML = `<button class="next-clue-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Siguiente Pista (${revealedClueCount}/${availableClues.length})</button>`;
                    } else {
                        playFooterHTML = `<button class="reveal-solution-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Revelar Soluci√≥n</button>`;
                    }
                    footerHTML = `<div class="flex flex-wrap justify-center gap-4">${playFooterHTML}</div>`;
                    break;

                case 'info':
                    contentHTML = options.content;
                    footerHTML = `<div class="text-center"><button class="close-modal-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button></div>`;
                    break;
            }

            dom.modalContent.innerHTML = contentHTML;
            dom.modalFooter.innerHTML = footerHTML;
            dom.modal.classList.add('active');
        }
        
        function openModalWithGame(game, view = null, options = {}) {
            let initialView = view;
            if (!initialView) {
                initialView = game.isSolved ? 'pre-solved' : 'summary';
            }
            renderModal(game, initialView, options);
        }
        
        function closeModal() { 
            dom.modal.classList.remove('active'); 
            currentGameData = null;
            revealedClueCount = 0; 
            history.pushState("", document.title, window.location.pathname + window.location.search);
        }
        
        function renderGames() {
            dom.enCursoContainer.innerHTML = '';
            dom.archivoGrid.innerHTML = '';

            const searchText = normalizeText(dom.searchText.value);
            const selectedDates = datePicker ? datePicker.selectedDates : [];
            const activeTypeFilter = dom.typeFilterContainer.querySelector('.filter-btn.active').dataset.type;
            const activeDifficultyFilter = dom.difficultyFilterContainer.querySelector('.filter-btn.active').dataset.difficulty;

            const enCursoGames = allGames.filter(game => game && !game.isSolved);
            let filteredArchivoGames = allGames.filter(game => game && game.isSolved);

            // Filtro Favoritos
            if (showFavoritesOnly) {
                filteredArchivoGames = filteredArchivoGames.filter(game => favorites.includes(game.id));
            }

            if (searchText) {
                filteredArchivoGames = filteredArchivoGames.filter(game => {
                    const gameTitle = normalizeText(game.title);
                    const gameNotes = normalizeText(game.notes);
                    const gameSolution = normalizeText(game.solution);
                    return gameTitle.includes(searchText) || gameNotes.includes(searchText) || gameSolution.includes(searchText);
                });
            }

            if (selectedDates && selectedDates.length === 2) {
                const from = new Date(selectedDates[0]); from.setHours(0,0,0,0);
                const to = new Date(selectedDates[1]); to.setHours(23,59,59,999);
                filteredArchivoGames = filteredArchivoGames.filter(game => {
                    const gameStartDate = new Date(game.startDate);
                    gameStartDate.setHours(0,0,0,0);
                    return gameStartDate >= from && gameStartDate <= to;
                });
            }

            if (activeTypeFilter !== 'Todos') {
                const normalizedActiveTypeFilter = normalizeText(activeTypeFilter);
                filteredArchivoGames = filteredArchivoGames.filter(game => game.type && normalizeText(game.type) === normalizedActiveTypeFilter);
            }
            
            if (activeDifficultyFilter !== 'Todos') {
                filteredArchivoGames = filteredArchivoGames.filter(game => game.difficulty === activeDifficultyFilter);
            }

            if (enCursoGames.length > 0) {
                enCursoGames.forEach(game => dom.enCursoContainer.appendChild(renderSummaryCard(game)));
            } else {
                dom.enCursoContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">A√∫n no hay misterios en curso. ¬°Vuelve pronto!</p>';
            }
            
            if (filteredArchivoGames.length > 0) {
                filteredArchivoGames.forEach(game => dom.archivoGrid.appendChild(renderSummaryCard(game)));
            } else {
                dom.archivoGrid.innerHTML = `<p class="text-center text-gray-400 col-span-full">No se encontraron misterios.</p>`;
            }
        }
        
        async function loadGames() {
            try {
                const response = await fetch(`${GAMES_INDEX_PATH}?v=${Date.now()}`);
                if (!response.ok) throw new Error(`Error √≠ndice`);
                const gameFiles = await response.json();
                
                const gamePromises = gameFiles.map(async (file) => {
                    try { const res = await fetch(`games/${file}?v=${Date.now()}`); return await res.json(); } 
                    catch (error) { return null; }
                });
                
                const games = (await Promise.all(gamePromises)).filter(Boolean);
                allGames = games.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
                renderGames();
            } catch (error) {
                dom.enCursoContainer.innerHTML = `<p class="text-red-500">Error cargando juegos.</p>`;
            }
        }
        
        // --- EVENT LISTENER SETUP ---

        function initEventListeners() {
            // Identity
            dom.myIdBtn.addEventListener('click', () => {
                initIdentity();
                dom.idModal.classList.add('active');
            });
            dom.closeIdModalBtn.addEventListener('click', () => dom.idModal.classList.remove('active'));
            dom.downloadIdBtn.addEventListener('click', downloadIdFile);
            dom.uploadIdBtn.addEventListener('click', () => dom.uploadIdInput.click());
            dom.uploadIdInput.addEventListener('change', handleIdUpload);

            // Redirect Modal
            dom.cancelRedirectBtn.addEventListener('click', () => dom.redirectModal.classList.remove('active'));
            dom.confirmRedirectBtn.addEventListener('click', () => {
                 dom.redirectModal.classList.remove('active');
                 window.open(pendingRedirectUrl, '_blank');
            });

            // Tabs
            dom.tabs.forEach(tab => {
                tab.addEventListener('click', (event) => {
                    const targetId = event.currentTarget.dataset.tab;
                    dom.tabs.forEach(t => t.classList.remove('active'));
                    event.currentTarget.classList.add('active');
                    dom.tabContents.forEach(content => content.id === targetId ? content.classList.remove('hidden') : content.classList.add('hidden'));
                    if (targetId === 'podio') loadPodium();
                });
            });

            // Favorites Filter
            dom.toggleFavoritesBtn.addEventListener('click', () => {
                showFavoritesOnly = !showFavoritesOnly;
                dom.toggleFavoritesBtn.classList.toggle('text-yellow-400', showFavoritesOnly);
                dom.toggleFavoritesText.textContent = showFavoritesOnly ? "Ver Todos" : "Solo Favoritos";
                renderGames();
            });

            // Standard Modal Events
            dom.modalCloseBtn.addEventListener('click', closeModal);
            dom.modal.addEventListener('click', (e) => { if (e.target === dom.modal) closeModal(); });
            
            // Filters
            dom.toggleFiltersBtn.addEventListener('click', () => { dom.filtersContainer.classList.toggle('hidden'); });
            dom.searchText.addEventListener('input', renderGames);
            dom.typeFilterContainer.addEventListener('click', (e) => { if(e.target.matches('.filter-btn')) { dom.typeFilterContainer.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); renderGames(); }});
            dom.difficultyFilterContainer.addEventListener('click', (e) => { if(e.target.matches('.filter-btn')) { dom.difficultyFilterContainer.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); renderGames(); }});

            // Dynamic Modal Clicks
            dom.modal.addEventListener('click', (e) => {
                const target = e.target.closest('button, a');
                if (!target) return;
                
                if (target.matches('.close-modal-btn')) { closeModal(); return; }
                if (target.matches('.view-clue-btn')) renderModal(currentGameData, 'single-clue', { clueIndex: parseInt(target.dataset.clueIndex, 10) });
                if (target.matches('#show-solution-btn') || target.matches('.view-all-clues-btn')) renderModal(currentGameData, 'all-clues');
                if (target.matches('.back-to-summary-btn')) renderModal(currentGameData, 'summary');
                if (target.matches('.share-btn')) copyToClipboard(`${window.location.origin}${window.location.pathname}#mystery=${target.dataset.gameId}`);
                if (target.matches('.share-clue-btn')) copyToClipboard(`${window.location.origin}${window.location.pathname}#mystery=${target.dataset.gameId}&clue=${target.dataset.clueIndex}`);
                
                // GUESS BTN LOGIC
                if (target.matches('.guess-btn')) {
                    e.preventDefault();
                    initIdentity(); // Ensure we have ID
                    copyToClipboard(userId);
                    showToast('¬°ID Copiado al portapapeles!');
                    
                    const baseUrl = target.dataset.link;
                    const entryId = target.dataset.entryId;
                    
                    if (entryId && userId) {
                        // Construct Google Form Pre-filled URL
                        // Standard format: url?entry.123456=VALUE
                        const separator = baseUrl.includes('?') ? '&' : '?';
                        pendingRedirectUrl = `${baseUrl}${separator}${entryId}=${userId}`;
                    } else {
                        pendingRedirectUrl = baseUrl;
                    }
                    
                    dom.redirectModalId.textContent = userId;
                    dom.redirectModal.classList.add('active');
                }

                // Spoiler Reveal
                if (target.matches('#reveal-spoiler-btn')) {
                    const content = document.getElementById('spoiler-content');
                    content.classList.remove('spoiler-blur');
                    content.classList.add('spoiler-revealed');
                    target.remove(); // Remove button
                }

                if (target.matches('.reveal-solution-btn')) {
                    const allCluesHTML = getVisibleClues(currentGameData).map((clue, i) => renderClue(clue, i)).join('');
                    const solutionHTML = getSolutionHTML(currentGameData, false);
                    dom.modalContent.innerHTML = `<div class="space-y-4">${allCluesHTML}${solutionHTML}</div>`;
                    // Switch to standard all-clues footer but solved
                    dom.modalFooter.innerHTML = `
                        <div class="flex flex-wrap justify-center gap-4">
                            <button class="back-to-summary-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Volver Atr√°s</button>
                            <button class="share-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-game-id="${currentGameData.id}">Compartir</button>
                        </div>`;
                }
                
                // Play Solved Logic
                if (target.matches('#play-solved-btn')) { revealedClueCount = 1; renderModal(currentGameData, 'play-solved'); }
                if (target.matches('.next-clue-btn')) { revealedClueCount++; renderModal(currentGameData, 'play-solved'); }
            });

            dom.instructionsBtn.addEventListener('click', () => {
                const content = `<div class="prose prose-invert max-w-none text-left text-gray-300"><h4>Novedades v8.0</h4><ul class="list-disc pl-5 mb-4"><li><strong>Identidad √önica:</strong> Tu progreso se vincula a tu ID. ¬°Gu√°rdalo!</li><li><strong>Favoritos:</strong> Marca los misterios que m√°s te gusten.</li><li><strong>Podio:</strong> Compite contra otros intersectres.</li></ul><h4>C√≥mo Jugar</h4><ol class="list-decimal pl-5 space-y-2"><li>Navega por las pesta√±as <strong>Misterios en Curso</strong> o <strong>Archivo</strong> para encontrar un juego.</li><li>Haz clic en un misterio para ver su resumen. Encontrar√°s una descripci√≥n y un √≠ndice de las pistas disponibles.</li><li>Puedes ver las pistas una por una haciendo clic en el √≠ndice, o todas juntas pulsando <strong>Mostrar Pistas y Resolver</strong>.</li><li>Pulsa <strong>¬°Adivina aqu√≠!</strong>: Tu ID se copiar√° y se rellenar√° autom√°ticamente en el formulario.</li><li>¬°Aseg√∫rate de usar siempre el mismo nombre en el formulario para subir en el Podio!</li><li>Puedes compartir un enlace al misterio o a una pista espec√≠fica usando los botones de compartir.</li><li>Para guardar una copia offline, usa el bot√≥n <strong>Descargar HTML</strong> para obtener un archivo con todas las pistas y la soluci√≥n (si est√° disponible).</li></ol><h4 class="mt-4">Tipos de Misterio</h4><ul class="list-disc pl-5 space-y-2"><li><strong>Semanal:</strong> El formato cl√°sico, con pistas que se revelan a lo largo de la semana.</li><li><strong>Diario/Rel√°mpago:</strong> Misterios m√°s cortos para resolver en menos tiempo.</li><li><strong>Especial:</strong> Eventos tem√°ticos o con reglas diferentes.</li><li><strong>Tutorial:</strong> Misterios dise√±ados para ense√±ar a jugar.</li></ul></div>`;
                renderModal(null, 'info', { title: "Instrucciones & Novedades", content: content });
            });
        }

        function init() {
            initIdentity();
            initFavorites();
            initEventListeners();
            
            datePicker = flatpickr(dom.searchDate, {
                mode: "range", dateFormat: "d/m/Y", locale: "es", altInput: true, altFormat: "j F, Y",
                onClose: renderGames,
                onReady: (_, __, instance) => instance.calendarContainer.classList.add('dark')
            });

            loadGames();
        }

        init();
    </script>
</body>
</html>
