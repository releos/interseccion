<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Misterios v9.0</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .clue-item { cursor: grab; }
        .clue-item:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #4f46e5; }
        .preview-content::-webkit-scrollbar { width: 8px; }
        .preview-content::-webkit-scrollbar-track { background: #1f2937; }
        .preview-content::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }
        .media-preview { max-width: 100%; height: auto; border-radius: 0.5rem; margin-top: 0.5rem; }
    </style>
</head>
<body class="text-gray-200">
    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">Generador de Misterios</h1>
            <p class="mt-2 text-lg text-gray-400">Crea juegos compatibles con el nuevo sistema de puntuaci贸n UTD.</p>
        </header>

        <div class="text-center mb-8 p-4 bg-gray-900/50 rounded-lg flex flex-wrap gap-4 justify-center">
            <label for="import-file-input" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Importar Misterio (.json)</label>
            <input type="file" id="import-file-input" accept=".json" class="hidden">
            <button id="export-json-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Exportar Misterio (.json)</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Panel de Control (Izquierda) -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 space-y-6">
                <fieldset class="border border-gray-700 rounded-lg p-4">
                    <legend class="text-lg font-bold text-indigo-400 px-2">Datos Principales</legend>
                    <div class="space-y-4">
                        <!-- NUEVO: ID y Bot贸n Copiar -->
                        <div class="bg-gray-900/50 p-3 rounded border border-gray-700 flex items-center justify-between gap-2">
                            <div class="flex-grow">
                                <span class="text-xs text-gray-500 uppercase font-bold">ID del Juego</span>
                                <div id="display-game-id" class="text-sm font-mono text-yellow-500 truncate select-all">...</div>
                            </div>
                            <button id="copy-id-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 px-3 rounded transition">Copiar ID</button>
                        </div>

                        <div>
                            <label for="game-title" class="block text-sm font-medium text-gray-300 mb-1">T铆tulo del Misterio</label>
                            <input type="text" id="game-title" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Ej: Objeto Misterioso">
                        </div>
                        <div>
                            <label for="game-type" class="block text-sm font-medium text-gray-300 mb-1">Tipo de Misterio</label>
                            <select id="game-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                                <option value="Semanal">Semanal</option>
                                <option value="Diario">Diario</option>
                                <option value="Rel谩mpago">Rel谩mpago</option>
                                <option value="Especial">Especial</option>
                                <option value="Tutorial">Tutorial</option>
                            </select>
                        </div>
                        <div>
                            <label for="game-difficulty" class="block text-sm font-medium text-gray-300 mb-1">Dificultad</label>
                            <select id="game-difficulty" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                                <option value="F谩cil">F谩cil </option>
                                <option value="Medio" selected>Medio </option>
                                <option value="Dif铆cil">Dif铆cil </option>
                            </select>
                        </div>
                        <div>
                            <label for="game-mystery" class="block text-sm font-medium text-gray-300 mb-1">El Misterio (Qu茅 es)</label>
                            <input type="text" id="game-mystery" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Ej: Una persona, un objeto...">
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-medium">驴Mostrar 'El Misterio'?</span>
                                <label for="show-mystery-toggle" class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="show-mystery-toggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label for="game-description" class="block text-sm font-medium text-gray-300 mb-1">Descripci贸n (Notas)</label>
                            <textarea id="game-description" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Una breve descripci贸n que aparecer谩 en la tarjeta..."></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="game-start-date" class="block text-sm font-medium text-gray-300 mb-1">Fecha de Inicio</label>
                                <input type="date" id="game-start-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                            </div>
                            <div>
                                <label for="google-form-link" class="block text-sm font-medium text-gray-300 mb-1">Link a Formulario Google</label>
                                <input type="url" id="google-form-link" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="https://docs.google.com/...">
                            </div>
                        </div>
                        <div>
                            <label for="google-form-entry-id" class="block text-sm font-medium text-yellow-400 mb-1">Google Form Entry ID</label>
                            <input type="text" id="google-form-entry-id" class="w-full bg-gray-700 border border-yellow-500/50 rounded-lg p-3" placeholder="Ej: entry.123456789">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border border-gray-700 rounded-lg p-4">
                    <legend class="text-lg font-bold text-indigo-400 px-2">Pistas (Arrastra para reordenar)</legend>
                    <p class="text-xs text-gray-500 mb-2 px-2">Nota: Al reordenar, las fechas se mantienen fijas en la posici贸n.</p>
                    <div id="clues-list" class="space-y-3 mb-4 min-h-[50px]"></div>
                    <div class="bg-gray-900/50 rounded-lg p-4 space-y-3">
                        <h4 class="font-semibold text-white">A帽adir nueva pista</h4>
                        <select id="new-clue-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                            <option value="text">Texto</option>
                            <option value="image">Imagen (URL)</option>
                            <option value="audio">Audio (URL)</option>
                            <option value="video">V铆deo (URL)</option>
                            <option value="link">Enlace (URL)</option>
                        </select>
                        <input type="text" id="new-clue-content" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Texto de la pista o URL directa al medio">
                        <div id="new-clue-text-wrapper" class="hidden"><input type="text" id="new-clue-text" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 mt-2" placeholder="Texto descriptivo (opcional para enlaces, etc.)"></div>
                        <div>
                            <label for="new-clue-publish-date" class="block text-sm font-medium text-gray-300 mb-1">Fecha de Publicaci贸n (CET)</label>
                            <input type="datetime-local" id="new-clue-publish-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                        </div>
                        <button id="add-clue-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-lg transition">A帽adir Pista</button>
                    </div>
                </fieldset>

                <fieldset class="border border-gray-700 rounded-lg p-4">
                    <legend class="text-lg font-bold text-indigo-400 px-2">Soluci贸n y Puntuaci贸n</legend>
                    <div class="space-y-4">
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-medium">驴Marcar como resuelto?</span>
                                <label for="is-solved-toggle" class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="is-solved-toggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                </label>
                            </div>
                            <div id="end-date-wrapper" class="hidden mt-4">
                                <label for="game-end-date" class="block text-sm font-medium text-gray-300 mb-1">Fecha de Fin</label>
                                <input type="date" id="game-end-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                            </div>
                        </div>

                        <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-lg">
                            <label for="game-utd" class="block text-sm font-bold text-indigo-300 mb-1">Unidad de Tiempo de Demora (UTD)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="game-utd" class="w-24 bg-gray-700 border border-gray-600 rounded-lg p-3 text-center font-mono" value="1" min="0.1" step="0.1">
                                <span class="text-gray-400">Horas</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Se restar谩 1 punto por cada UTD que pase tras revelarse la 煤ltima pista.</p>
                        </div>

                        <div>
                            <label for="game-solution" class="block text-sm font-medium text-gray-300 mb-1">La Soluci贸n</label>
                            <input type="text" id="game-solution" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Ej: El Cubo de Rubik">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="game-winner" class="block text-sm font-medium text-gray-300 mb-1">Nombre Ganador/a</label>
                                <input type="text" id="game-winner" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Ej: @nombre">
                            </div>
                            <div>
                                <label for="game-winner-id" class="block text-sm font-medium text-gray-300 mb-1">ID del Ganador/a</label>
                                <input type="text" id="game-winner-id" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="UUID del usuario">
                            </div>
                        </div>
                        <div>
                            <label for="game-explanation" class="block text-sm font-medium text-gray-300 mb-1">Explicaci贸n de la Soluci贸n</label>
                            <textarea id="game-explanation" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Detalles de por qu茅 la soluci贸n es la correcta..."></textarea>
                        </div>
                        <div>
                            <label for="winner-explanation" class="block text-sm font-medium text-gray-300 mb-1">Explicaci贸n del Ganador</label>
                            <textarea id="winner-explanation" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Detalles de c贸mo el ganador/a resolvi贸 el misterio..."></textarea>
                        </div>
                    </div>
                </fieldset>
                
                <!-- NUEVO: Panel de Descarga de Previsualizaci贸n -->
                <fieldset class="border border-gray-700 rounded-lg p-4 bg-teal-900/10">
                    <legend class="text-lg font-bold text-teal-400 px-2">Descargar Previsualizaci贸n (HTML)</legend>
                    <div class="space-y-4">
                        <p class="text-sm text-gray-400">Genera un archivo HTML jugable para probar o archivar.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <label class="bg-gray-700 p-3 rounded cursor-pointer hover:bg-gray-600 flex items-center gap-2">
                                <input type="radio" name="dl-preview-mode" value="full" checked class="text-teal-500">
                                <span class="text-sm">Todo (Con Soluci贸n)</span>
                            </label>
                            <label class="bg-gray-700 p-3 rounded cursor-pointer hover:bg-gray-600 flex items-center gap-2">
                                <input type="radio" name="dl-preview-mode" value="no-solution" class="text-teal-500">
                                <span class="text-sm">Sin Soluci贸n</span>
                            </label>
                            <label class="bg-gray-700 p-3 rounded cursor-pointer hover:bg-gray-600 flex items-center gap-2">
                                <input type="radio" name="dl-preview-mode" value="partial" class="text-teal-500">
                                <span class="text-sm">Solo unas pistas</span>
                            </label>
                        </div>
                        <div id="dl-preview-count-wrapper" class="hidden">
                            <label class="block text-xs font-bold text-gray-400 mb-1">N煤mero de pistas a incluir:</label>
                            <input type="number" id="dl-preview-count" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" min="1" value="1">
                        </div>
                        <button id="download-preview-html-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Descargar HTML
                        </button>
                    </div>
                </fieldset>

                <fieldset class="border border-gray-700 rounded-lg p-4">
                    <legend class="text-lg font-bold text-indigo-400 px-2">Bibliograf铆a / Fuentes</legend>
                    <textarea id="game-bibliography" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="A帽ade aqu铆 las fuentes, enlaces o bibliograf铆a utilizada..."></textarea>
                    <button id="download-bibliography-btn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold p-3 rounded-lg transition">Descargar Bibliograf铆a (PDF)</button>
                </fieldset>
            </div>

            <!-- Panel de Previsualizaci贸n (Derecha) -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 space-y-6 flex flex-col">
                <h2 class="text-3xl font-bold text-indigo-400">Previsualizaci贸n</h2>
                <div id="preview-wrapper" class="flex-grow bg-gray-900 rounded-lg p-6 overflow-y-auto preview-content">
                    <!-- Contenido de previsualizaci贸n -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modales (Edit Clue & Alert) - Mismos que versi贸n anterior -->
    <div id="edit-clue-modal" class="modal fixed inset-0 z-50 bg-gray-950 bg-opacity-75 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 max-w-lg w-full">
            <h3 class="text-2xl font-extrabold text-indigo-400 mb-4">Editar Pista</h3>
            <div class="space-y-4">
                <select id="edit-clue-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                    <option value="text">Texto</option>
                    <option value="image">Imagen (URL)</option>
                    <option value="audio">Audio (URL)</option>
                    <option value="video">V铆deo (URL)</option>
                    <option value="link">Enlace (URL)</option>
                </select>
                <input type="text" id="edit-clue-content" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Contenido de la pista">
                <div id="edit-clue-text-wrapper" class="hidden"><input type="text" id="edit-clue-text" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3" placeholder="Texto descriptivo (opcional)"></div>
                <div>
                    <label for="edit-clue-publish-date" class="block text-sm font-medium text-gray-300 mb-1">Fecha de Publicaci贸n (CET)</label>
                    <input type="datetime-local" id="edit-clue-publish-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="save-clue-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Guardar</button>
                <button id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal fixed inset-0 z-50 bg-gray-950 bg-opacity-75 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 max-w-sm w-full text-center">
            <h3 id="alert-title" class="text-2xl font-extrabold text-white mb-4"></h3>
            <p id="alert-message" class="text-gray-300 mb-6"></p>
            <button id="close-alert-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Aceptar</button>
        </div>
    </div>

    <script>
        const dom = {
            titleInput: document.getElementById('game-title'),
            typeInput: document.getElementById('game-type'),
            difficultyInput: document.getElementById('game-difficulty'),
            mysteryInput: document.getElementById('game-mystery'),
            showMysteryToggle: document.getElementById('show-mystery-toggle'),
            descriptionInput: document.getElementById('game-description'),
            startDateInput: document.getElementById('game-start-date'),
            formLinkInput: document.getElementById('google-form-link'),
            formEntryIdInput: document.getElementById('google-form-entry-id'),
            cluesList: document.getElementById('clues-list'),
            displayGameId: document.getElementById('display-game-id'),
            copyIdBtn: document.getElementById('copy-id-btn'),
            newClue: {
                type: document.getElementById('new-clue-type'),
                content: document.getElementById('new-clue-content'),
                textWrapper: document.getElementById('new-clue-text-wrapper'),
                text: document.getElementById('new-clue-text'),
                publishDate: document.getElementById('new-clue-publish-date'),
                addBtn: document.getElementById('add-clue-btn')
            },
            solution: {
                isSolvedToggle: document.getElementById('is-solved-toggle'),
                endDateWrapper: document.getElementById('end-date-wrapper'),
                endDate: document.getElementById('game-end-date'),
                utdInput: document.getElementById('game-utd'), 
                solutionInput: document.getElementById('game-solution'),
                winnerInput: document.getElementById('game-winner'),
                winnerIdInput: document.getElementById('game-winner-id'),
                explanationInput: document.getElementById('game-explanation'),
                winnerExplanationInput: document.getElementById('winner-explanation')
            },
            bibliography: {
                textarea: document.getElementById('game-bibliography'),
                downloadBtn: document.getElementById('download-bibliography-btn')
            },
            preview: { wrapper: document.getElementById('preview-wrapper') },
            downloadPreview: {
                modes: document.getElementsByName('dl-preview-mode'),
                countWrapper: document.getElementById('dl-preview-count-wrapper'),
                countInput: document.getElementById('dl-preview-count'),
                btn: document.getElementById('download-preview-html-btn')
            },
            exportBtn: document.getElementById('export-json-btn'),
            importInput: document.getElementById('import-file-input'),
            editClueModal: document.getElementById('edit-clue-modal'),
            editClueType: document.getElementById('edit-clue-type'),
            editClueContent: document.getElementById('edit-clue-content'),
            editClueTextWrapper: document.getElementById('edit-clue-text-wrapper'),
            editClueText: document.getElementById('edit-clue-text'),
            editCluePublishDate: document.getElementById('edit-clue-publish-date'),
            saveClueBtn: document.getElementById('save-clue-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            alertModal: document.getElementById('alert-modal'),
            alertTitle: document.getElementById('alert-title'),
            alertMessage: document.getElementById('alert-message'),
            closeAlertBtn: document.getElementById('close-alert-btn')
        };

        let gameState = {
            id: crypto.randomUUID(),
            title: '', type: 'Semanal', difficulty: 'Medio', mystery: '', showMystery: true, notes: '', startDate: '', googleFormLink: '', formEntryId: '',
            clues: [],
            isSolved: false, endDate: '', solution: '', winner: '', winnerId: '', explanation: '', winnerExplanation: '', bibliography: '',
            utd: 1, 
            lastUpdated: new Date().toISOString()
        };

        let currentEditingIndex = null;

        function showAlert(title, message) { dom.alertTitle.textContent = title; dom.alertMessage.innerHTML = message; dom.alertModal.classList.add('active'); }
        function closeModal(modal) { modal.classList.remove('active'); }
        function toLocalISOString(date) { const tzoffset = (new Date()).getTimezoneOffset() * 60000; return (new Date(date - tzoffset)).toISOString().slice(0, -1); }

        function updateStateFromUI() {
            gameState.title = dom.titleInput.value;
            gameState.type = dom.typeInput.value;
            gameState.difficulty = dom.difficultyInput.value;
            gameState.mystery = dom.mysteryInput.value;
            gameState.showMystery = dom.showMysteryToggle.checked;
            gameState.notes = dom.descriptionInput.value;
            gameState.startDate = dom.startDateInput.value;
            gameState.googleFormLink = dom.formLinkInput.value;
            gameState.formEntryId = dom.formEntryIdInput.value;
            gameState.isSolved = dom.solution.isSolvedToggle.checked;
            gameState.endDate = dom.solution.endDate.value;
            gameState.utd = parseFloat(dom.solution.utdInput.value) || 1; 
            gameState.solution = dom.solution.solutionInput.value;
            gameState.winner = dom.solution.winnerInput.value;
            gameState.winnerId = dom.solution.winnerIdInput.value;
            gameState.explanation = dom.solution.explanationInput.value;
            gameState.winnerExplanation = dom.solution.winnerExplanationInput.value;
            gameState.bibliography = dom.bibliography.textarea.value;
            gameState.lastUpdated = new Date().toISOString();
        }

        function updateUIFromState() {
            dom.displayGameId.textContent = gameState.id || '...';
            dom.titleInput.value = gameState.title || '';
            dom.typeInput.value = gameState.type || 'Semanal';
            dom.difficultyInput.value = gameState.difficulty || 'Medio';
            dom.mysteryInput.value = gameState.mystery || '';
            dom.showMysteryToggle.checked = gameState.showMystery ?? true;
            dom.descriptionInput.value = gameState.notes || '';
            dom.startDateInput.value = gameState.startDate || '';
            dom.formLinkInput.value = gameState.googleFormLink || '';
            dom.formEntryIdInput.value = gameState.formEntryId || '';
            dom.solution.isSolvedToggle.checked = gameState.isSolved || false;
            dom.solution.solutionInput.value = gameState.solution || '';
            dom.solution.winnerInput.value = gameState.winner || '';
            dom.solution.winnerIdInput.value = gameState.winnerId || '';
            dom.solution.explanationInput.value = gameState.explanation || '';
            dom.solution.winnerExplanationInput.value = gameState.winnerExplanation || '';
            dom.solution.endDate.value = gameState.endDate || '';
            dom.solution.utdInput.value = gameState.utd || 1; 
            dom.bibliography.textarea.value = gameState.bibliography || '';
            dom.solution.endDateWrapper.classList.toggle('hidden', !gameState.isSolved);
            toggleDescriptionField(dom.newClue.textWrapper, dom.newClue.type.value);
            renderAll();
        }

        function renderCluesList() {
            dom.cluesList.innerHTML = '';
            gameState.clues.forEach((clue, index) => {
                const clueItem = document.createElement('div');
                clueItem.className = 'clue-item bg-gray-700/50 rounded-lg p-3 flex items-center justify-between gap-4 transition-colors hover:bg-gray-700';
                clueItem.dataset.index = index;
                clueItem.innerHTML = `<div class="flex items-center gap-4 flex-grow"><span class="text-indigo-400 font-bold w-6">${index + 1}</span><div class="flex-grow"><p class="text-sm font-medium text-gray-100">${clue.text || clue.content}</p><p class="text-xs text-gray-400">Tipo: <span class="capitalize">${clue.type}</span> | Publicaci贸n: ${(clue.publishDate || '').replace('T', ' ')}</p></div></div><div class="flex-shrink-0 flex gap-2"><button class="edit-clue-btn p-1 text-gray-400 hover:text-yellow-400 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"/></svg></button><button class="delete-clue-btn p-1 text-gray-400 hover:text-red-400 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div>`;
                dom.cluesList.appendChild(clueItem);
            });
        }

        function renderPreview() {
            let contentHTML = `<div class="space-y-4"><div class="flex items-start justify-between flex-wrap gap-2"><h3 class="text-3xl font-extrabold text-white">${gameState.title || 'T铆tulo'}</h3></div><p class="text-gray-400">${gameState.notes || ''}</p><p class="text-xs text-indigo-400">UTD Configurada: ${gameState.utd} hora(s)</p><hr class="border-gray-700"><ul class="space-y-2 list-disc list-inside text-gray-300">${gameState.clues.map(c => `<li>${c.text || c.content} <span class="text-xs text-gray-500">(${c.publishDate})</span></li>`).join('')}</ul></div>`;
            dom.preview.wrapper.innerHTML = contentHTML;
        }

        function renderAll() { renderCluesList(); renderPreview(); }
        function toggleDescriptionField(wrapper, type) { wrapper.classList.toggle('hidden', ['text'].includes(type)); }

        function openEditClueModal(index) {
            currentEditingIndex = index;
            const clue = gameState.clues[index];
            dom.editClueType.value = clue.type; dom.editClueContent.value = clue.content; dom.editClueText.value = clue.text || ''; dom.editCluePublishDate.value = clue.publishDate;
            toggleDescriptionField(dom.editClueTextWrapper, clue.type); dom.editClueModal.classList.add('active');
        }

        // --- Funciones para generar HTML de descarga ---
        function generateClueHTML(clue, index) {
            let mainTextHTML = '', mediaHTML = '';
            const textContent = clue.type === 'text' ? clue.content : (clue.text || '');
            if (textContent) mainTextHTML = `<div class="prose prose-invert max-w-none prose-p:text-gray-300 prose-p:my-0">${textContent.replace(/\n/g, '<br>')}</div>`;

            if (clue.type !== 'text' && clue.content) {
                let url = clue.content;
                if (!/^https?:\/\//i.test(url)) { url = 'https://' + url; }
                switch (clue.type) {
                    case 'image': mediaHTML = `<img src="${url}" alt="Pista" class="mt-4 rounded-lg w-full h-auto object-contain max-h-96">`; break;
                    case 'audio': mediaHTML = `<audio controls src="${url}" class="mt-4 w-full"></audio>`; break;
                    case 'video': mediaHTML = `<div class="relative mt-4" style="padding-bottom: 56.25%"><iframe src="${url}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-lg"></iframe></div>`; break;
                    case 'link': mediaHTML = `<a href="${url}" target="_blank" class="mt-4 inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg"><span>Abrir Enlace</span></a>`; break;
                }
            }
            return `<div class="flex items-start gap-4 p-4 bg-gray-900/50 rounded-lg"><div class="flex-shrink-0 bg-indigo-600 h-8 w-8 rounded-full flex items-center justify-center font-bold text-white text-sm">${index + 1}</div><div class="flex-grow min-w-0">${mainTextHTML}${mediaHTML}</div></div>`;
        }

        function generateSolutionHTML(game) {
            const explanationHTML = game.explanation ? `<p>${game.explanation.replace(/\n/g, '<br>')}</p>` : '<p>Sin explicaci贸n.</p>';
            let winnerHTML = game.winner ? `<p class="text-lg text-yellow-400 mt-2">隆Adivinado por <strong>${game.winner}</strong>!</p>` : '';
            return `<div class="mt-6 border-t-2 border-green-500 pt-6 space-y-4 relative"><h3 class="text-2xl font-bold text-green-400">Soluci贸n Final</h3><div class="bg-green-900/50 border border-green-500 rounded-lg p-6 text-center"><p class="text-4xl font-extrabold text-white break-words">${game.solution || 'N/A'}</p>${winnerHTML}</div><div class="prose prose-invert max-w-none prose-p:text-gray-300"><h4 class="text-2xl font-bold text-white mt-6 mb-2">Explicaci贸n</h4>${explanationHTML}</div></div>`;
        }

        function downloadPreviewHTML() {
            let mode = 'full';
            dom.downloadPreview.modes.forEach(r => { if(r.checked) mode = r.value; });
            const clueCount = parseInt(dom.downloadPreview.countInput.value) || 1;

            let cluesToRender = gameState.clues;
            if (mode === 'partial') {
                cluesToRender = gameState.clues.slice(0, clueCount);
            }

            const cluesHTML = cluesToRender.map((c, i) => generateClueHTML(c, i)).join('');
            
            let solutionHTML = '';
            if (mode === 'full') {
                solutionHTML = generateSolutionHTML(gameState);
            }

            const html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>${gameState.title}</title><script src="https://cdn.tailwindcss.com"><\/script><style>body { background-color: #111827; color: #e5e7eb; font-family: sans-serif; }</style></head><body class="p-8"><div class="max-w-2xl mx-auto bg-gray-800 rounded-lg p-8 space-y-4 shadow-xl"><h1 class="text-3xl font-bold text-white">${gameState.title}</h1><p class="text-gray-400">${gameState.notes || ''}</p><hr class="border-gray-600">${cluesHTML}${solutionHTML}</div></body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; 
            let filename = `preview_${gameState.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}`;
            if(mode === 'partial') filename += `_pistas1-${cluesToRender.length}`;
            a.download = `${filename}.html`; 
            a.click(); URL.revokeObjectURL(url);
        }

        function initEventListeners() {
            document.querySelectorAll('input, textarea, select').forEach(input => { input.addEventListener('input', () => { updateStateFromUI(); renderPreview(); }); });
            dom.showMysteryToggle.addEventListener('change', () => { gameState.showMystery = dom.showMysteryToggle.checked; renderPreview(); });
            dom.solution.isSolvedToggle.addEventListener('change', () => { gameState.isSolved = dom.solution.isSolvedToggle.checked; dom.solution.endDateWrapper.classList.toggle('hidden', !gameState.isSolved); renderPreview(); });

            dom.copyIdBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(gameState.id).then(() => {
                    const originalText = dom.copyIdBtn.textContent;
                    dom.copyIdBtn.textContent = '隆Copiado!';
                    setTimeout(() => dom.copyIdBtn.textContent = originalText, 2000);
                });
            });

            dom.downloadPreview.modes.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    dom.downloadPreview.countWrapper.classList.toggle('hidden', e.target.value !== 'partial');
                });
            });

            dom.downloadPreview.btn.addEventListener('click', downloadPreviewHTML);

            dom.newClue.addBtn.addEventListener('click', () => {
                const newClue = { type: dom.newClue.type.value, content: dom.newClue.content.value, text: dom.newClue.text.value || null, publishDate: dom.newClue.publishDate.value };
                if (newClue.content && newClue.publishDate) { gameState.clues.push(newClue); dom.newClue.content.value = ''; dom.newClue.text.value = ''; updateUIFromState(); } else { showAlert('Error', 'Faltan datos.'); }
            });

            dom.newClue.type.addEventListener('change', (e) => toggleDescriptionField(dom.newClue.textWrapper, e.target.value));

            dom.exportBtn.addEventListener('click', () => {
                updateStateFromUI();
                const jsonStr = JSON.stringify(gameState, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${(gameState.title || 'misterio').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`; a.click(); URL.revokeObjectURL(url);
            });

            dom.importInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        if (importedState && importedState.id) {
                            gameState = { ...gameState, ...importedState, clues: importedState.clues || [], utd: importedState.utd || 1 };
                            updateUIFromState(); showAlert('Importado', 'Misterio cargado.');
                        } else showAlert("Error", "Formato inv谩lido.");
                    } catch (error) { showAlert("Error", "No se pudo leer el archivo."); }
                }
                reader.readAsText(file); event.target.value = '';
            });

            dom.cluesList.addEventListener('click', (e) => {
                const target = e.target.closest('button'); if (!target) return;
                const index = parseInt(target.closest('.clue-item').dataset.index, 10);
                if (target.classList.contains('edit-clue-btn')) openEditClueModal(index);
                else if (target.classList.contains('delete-clue-btn')) { gameState.clues.splice(index, 1); updateUIFromState(); }
            });

            Sortable.create(dom.cluesList, { animation: 150, ghostClass: 'sortable-ghost', onEnd: (evt) => {
                // 1. Guardar las fechas originales en su orden original
                const dates = gameState.clues.map(c => c.publishDate);
                
                // 2. Mover el elemento en el array (el contenido cambia de posici贸n)
                const [item] = gameState.clues.splice(evt.oldIndex, 1);
                gameState.clues.splice(evt.newIndex, 0, item);
                
                // 3. Reasignar las fechas originales a las nuevas posiciones
                // Esto hace que la fecha de la Posici贸n 1 siga siendo la fecha de la Posici贸n 1,
                // aunque el contenido ahora sea diferente.
                gameState.clues.forEach((clue, index) => {
                    clue.publishDate = dates[index];
                });
                
                renderAll();
            }});

            dom.saveClueBtn.addEventListener('click', () => {
                if (currentEditingIndex !== null) {
                    gameState.clues[currentEditingIndex] = { type: dom.editClueType.value, content: dom.editClueContent.value, text: dom.editClueText.value || null, publishDate: dom.editCluePublishDate.value };
                    updateUIFromState(); closeModal(dom.editClueModal); currentEditingIndex = null;
                }
            });

            dom.cancelEditBtn.addEventListener('click', () => closeModal(dom.editClueModal));
            dom.closeAlertBtn.addEventListener('click', () => closeModal(dom.alertModal));

             dom.bibliography.downloadBtn.addEventListener('click', () => {
                const bibContent = dom.bibliography.textarea.value;
                if (!bibContent.trim()) { showAlert('Error', 'Bibliograf铆a vac铆a.'); return; }
                const element = document.createElement('div'); element.style.padding = '2rem'; element.style.fontFamily = 'sans-serif';
                element.innerHTML = `<h1>Bibliograf铆a: ${gameState.title}</h1><pre>${bibContent}</pre>`;
                html2pdf().from(element).save(`${gameState.title}_bibliografia.pdf`);
            });
        }

        function init() {
            const now = new Date(); dom.startDateInput.value = toLocalISOString(now).slice(0, 10); dom.newClue.publishDate.value = toLocalISOString(now).slice(0, 16);
            initEventListeners(); updateStateFromUI(); updateUIFromState();
        }
        window.addEventListener('load', init);
    </script>
</body>
</html>
